<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Compras - Execução</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{margin:0;font-family:'Orbitron',Arial,sans-serif;background:radial-gradient(circle at top,#0a0a0a,#000);color:#00e5ff;}
header{padding:14px;background:linear-gradient(90deg,#bdbdbd,#e0e0e0,#bdbdbd);color:#000;font-weight:900;text-align:center;}
.container{padding:14px;max-width:1100px;margin:auto;}
.card{background:rgba(0,0,0,.78);border-radius:18px;padding:16px;border:2px solid rgba(0,229,255,.22);box-shadow:0 0 26px rgba(0,229,255,.22);margin-bottom:12px;}
h2{margin-top:0;color:#ff3d00;text-align:center;}
table{width:100%;border-collapse:collapse;font-size:.85rem;}
th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.15);text-align:left;vertical-align:top;}
input{width:100%;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.08);color:#fff;font-family:'Orbitron';}
button{padding:8px 12px;border-radius:12px;border:none;font-family:'Orbitron',Arial,sans-serif;font-weight:900;cursor:pointer;}
.btn-ok{background:linear-gradient(90deg,#00c853,#64dd17);color:#000;}
.btn-blue{background:linear-gradient(90deg,#2979ff,#00e5ff);color:#000;}
.small{font-size:.75rem;opacity:.8;}
    .filters{display:flex;gap:10px;justify-content:flex-start;flex-wrap:wrap;margin:8px 0 14px;}
    .fbtn{background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.22);}
    .fbtn.active{background:linear-gradient(90deg,#00c853,#64dd17);color:#000;border:none;}

</style>
</head>

<body>
<header>Setor de Compras</header>

<div class="container">
  <div class="card">
    <h2>Compras Autorizadas</h2>
    <div class="filters" id="filters">
      <button class="fbtn active" data-filter="all">Todos</button>
      <button class="fbtn" data-filter="comprar">Comprar</button>
      <button class="fbtn" data-filter="darentrada">Dar entrada</button>
      <button class="fbtn" data-filter="finalizado">Finalizado</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>Solicitação</th>
          <th>Item</th>
          <th>Fornecedor</th>
          <th>Valores</th>
          <th>Previsão</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
<datalist id="dlSuppliers"></datalist>

  </div>
</div>

<script>
function esc(s){return String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}
const firebaseConfig={
  apiKey:"AIzaSyBPz4aSee-kQY5hwlyzEw_4Jv3gGKL9iHY",
  authDomain:"tmg-painel.firebaseapp.com",
  databaseURL:"https://tmg-painel-default-rtdb.firebaseio.com",
  projectId:"tmg-painel",
  storageBucket:"tmg-painel.firebasestorage.app",
  messagingSenderId:"877912378151",
  appId:"1:877912378151:web:88af3a4f8f551acd603702"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

function normStatus(s){
  if(!s) return "";
  const t=String(s).trim().toLowerCase();
  if(t==="autorizado") return "authorized";
  if(t==="comprado") return "purchased";
  if(t==="recebido"||t==="chegou") return "received";
  if(t==="finalizado") return "finalized";
  if(t==="requested"||t==="solicitado") return "requested";
  return t;
}

let currentFilter="all";
function setFilter(v){
  currentFilter=v;
  document.querySelectorAll(".fbtn").forEach(b=>b.classList.toggle("active", b.dataset.filter===v));
  render(currentData);
}
window.addEventListener("click",(e)=>{
  const b=e.target.closest?.(".fbtn");
  if(!b) return;
  setFilter(b.dataset.filter);
});


function fmt(ts){
  if(!ts) return "-";
  const d=new Date(ts);
  if(isNaN(d.getTime())) return "-";
  return d.toLocaleString("pt-BR");
}


function refreshSuggestions(all){
  const supSet = new Set();
  all.forEach(r=>{
    const n = r.supplier && r.supplier.name ? String(r.supplier.name).trim() : "";
    if(n) supSet.add(n);
  });
  const dl = document.getElementById("dlSuppliers");
  if(dl){
    dl.innerHTML = Array.from(supSet).sort().map(v=>`<option value="${esc(v)}"></option>`).join("");
  }
}

let currentData = {};
function render(all){
  const tbody=document.getElementById("rows");
  tbody.innerHTML="";
  Object.entries(all).forEach(([id,r])=>{
    if(!["authorized","purchased","received"].includes(r.status)) return;

    if(currentFilter==="comprar" && r.status!=="authorized") return;
    if(currentFilter==="darentrada" && r.status!=="purchased") return;
    if(currentFilter==="finalizado" && r.status!=="received") return;

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>
        <b>${esc(r.member||r.requestedBy||r.requester||"-")}</b><br>
        <span class="small">${fmt(r.requestedAt)}</span><br>
        ${esc(r.cost||"-")}
      </td>
      <td>
        ${esc(r.item||"-")}<br>
        <span class="small">${esc(r.qty||"")} ${esc(r.unit||"")}</span>
      </td>
      <td>
        <input placeholder="Fornecedor" value="${esc(r.supplier?.name||"")}" onchange="upd('${id}','supplier/name',this.value)">
        <input placeholder="Contato" value="${esc(r.supplier?.contact||"")}" onchange="upd('${id}','supplier/contact',this.value)">
        <input placeholder="Link" value="${esc(r.supplier?.link||"")}" onchange="upd('${id}','supplier/link',this.value)">
      </td>
      <td>
        <input type="number" step="0.01" placeholder="Valor total" value="${r.total??""}" onchange="upd('${id}','total',Number(this.value))">
      </td>
      <td>
        <input type="datetime-local" value="${r.expectedDelivery?new Date(r.expectedDelivery).toISOString().slice(0,16):""}" onchange="upd('${id}','expectedDelivery',this.value?new Date(this.value).getTime():null)">
        ${r.expectedDelivery?'<div class="small">'+fmt(r.expectedDelivery)+'</div>':''}
      </td>
      <td>
        ${status==="authorized"
          ? `<button class="btn-blue" onclick="markPurchased('${id}')">Comprar</button>`
          : (status==="purchased"
            ? `<button class="btn-ok" onclick="markReceived('${id}')">Dar entrada</button>`
            : `<span class="small">Finalizado</span>`)}
      </td>
    `;
    tbody.appendChild(tr);
  });
}

db.ref("purchaseRequests").on("value",snap=>{
  currentData=snap.val()||{};
  refreshSuggestions(currentData);
  render(currentData);
});
});

function upd(id,path,val){
  const obj={};
  obj[path]=val;
  db.ref("purchaseRequests/"+id).update(obj);
}

function markPurchased(id){
  db.ref("purchaseRequests/"+id).update({
    status:"purchased",
    purchasedAt:Date.now()
  });
}

function markReceived(id){
  db.ref("purchaseRequests/"+id).update({
    status:"received",
    receivedAt:Date.now()
  });
}
</script>
</body>
</html>
