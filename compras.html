<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Compras / Serviços</title>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    body{margin:0;background:#050505;color:#fff;font-family:Arial, Helvetica, sans-serif}
    header{height:70px;background:linear-gradient(#dedede,#cfcfcf);display:flex;align-items:center;justify-content:space-between;padding:0 22px}
    header .t{font-weight:900;color:#111;font-size:18px;letter-spacing:.5px}
    header .r{font-weight:800;color:#111;font-size:22px}
    .wrap{max-width:1200px;margin:30px auto;padding:0 18px}
    .card{background:rgba(0,0,0,.72);border:2px solid rgba(0,255,255,.35);border-radius:18px;box-shadow:0 0 18px rgba(0,255,255,.12);padding:22px}
    h1{margin:0 0 14px;text-align:center;color:#ff7a00;letter-spacing:1px}

    .filters{display:flex;gap:12px;margin:2px 0 16px}
    .fbtn{background:#222;border:1px solid rgba(0,255,255,.35);color:#fff;border-radius:18px;padding:8px 14px;cursor:pointer;font-weight:800}
    .fbtn.active{background:linear-gradient(90deg,#00e676,#00c853);color:#0b0b0b;border-color:transparent}

    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 10px;border-bottom:1px solid rgba(0,255,255,.16)}
    th{color:#00e5ff;font-size:13px;text-transform:uppercase;letter-spacing:1px}
    td{color:#eaeaea}
    input{width:100%;background:#1b1b1b;border:1px solid rgba(255,255,255,.1);color:#fff;border-radius:12px;padding:10px 12px;outline:none}
    .moneywrap{display:flex;align-items:center;gap:8px}
    .rs{background:#101010;border:1px solid rgba(0,255,255,.25);color:#00e5ff;border-radius:10px;padding:8px 10px;font-weight:900}
    .act{display:flex;justify-content:flex-end}
    .buyBtn{background:linear-gradient(90deg,#00e676,#00c853);border:none;color:#0b0b0b;border-radius:18px;padding:10px 18px;cursor:pointer;font-weight:900}
    .recvBtn{background:linear-gradient(90deg,#2196f3,#1976d2);border:none;color:#fff;border-radius:18px;padding:10px 18px;cursor:pointer;font-weight:900}
    .badge{display:inline-block;border-radius:18px;padding:10px 16px;font-weight:900}
    .badge.finalizado{background:linear-gradient(90deg,#7c4dff,#b388ff); color:#0b0b0b; font-weight:800;}
  </style>
</head>

<body>
  <header>
    <div class="t">TMG Racing</div>
    <div class="r">Compras / Serviços</div>
  </header>

  <div class="wrap">
    <div class="card">
      <h1>Compras Autorizadas</h1>

      <div class="filters">
    <button class="fbtn active" onclick="setFilter('all')">Todos</button>
    <button class="fbtn" onclick="setFilter('comprar')">Comprar</button>
    <button class="fbtn" onclick="setFilter('entrada')">Entrada</button>
    <button class="fbtn" onclick="setFilter('finalizado')">Finalizado</button>
  </div>

      <table>
        <thead>
          <tr>
            <th>Solicitante</th>
            <th>Item</th>
            <th>Fornecedor</th>
            <th>Valor</th>
            <th>Previsão</th>
            <th>Ação</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script>
  let currentFilter = 'all';

    // ==== Firebase config (mesma base do seu arquivo) ====
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DATABASE_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    try { firebase.initializeApp(firebaseConfig); } catch(e) {}
    const db = firebase.database();

    const tbody = document.getElementById('tbody');
    let reqs = [];

    function fmtMoney(v){
      const n = parseFloat(String(v||'').replace(',','.'));
      if(isNaN(n)) return '-';
      return n.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2});
    }

    function fmtDate(v){
      if(!v) return '-';
      // aceita "YYYY-MM-DD" ou timestamp
      if(typeof v === 'number'){
        const d = new Date(v);
        if(isNaN(d.getTime())) return '-';
        return d.toLocaleDateString('pt-BR');
      }
      const s = String(v);
      if(/^\d{4}-\d{2}-\d{2}$/.test(s)){
        const [y,m,d]=s.split('-');
        return `${d}/${m}/${y}`;
      }
      return s;
    }

    function upd(id, path, value){
      if(!id) return;
      const p = `purchaseRequests/${id}/${path}`;
      db.ref(p).set(value);
    }

    function updNum(id, path, value){
      const v = String(value||'').replace(',','.');
      const n = parseFloat(v);
      upd(id, path, isNaN(n) ? 0 : n);
    }

    function buy(id){
      // authorized -> purchased
      db.ref(`purchaseRequests/${id}`).update({ status:'purchased' });
    }

    function recv(id){
      // purchased -> received
      db.ref(`purchaseRequests/${id}`).update({ status:'received' });
    }

    function setFilter(kind){
      currentFilter = kind || 'all';
      // ativa visual
      document.querySelectorAll('.fbtn').forEach((b)=>b.classList.remove('active'));
      const map = {all:0, comprar:1, entrada:2, finalizado:3};
      const idx = map[currentFilter] ?? 0;
      const btns = document.querySelectorAll('.filters .fbtn');
      if(btns[idx]) btns[idx].classList.add('active');
      render();
    }

    function render(){
      tbody.innerHTML = '';

      reqs.forEach(r=>{
        // status esperado: authorized / purchased / received
        const st = (r.status || 'authorized');

        let show = true;
        if(currentFilter==='comprar') show = (st==='authorized');
        else if(currentFilter==='entrada') show = (st==='purchased');
        else if(currentFilter==='finalizado') show = (st==='received');

        if(!show) return;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${(r.requesterName||r.solicitante||r.requestedBy||r.member||'-')}</td>
          <td><input value="${(r.item||'')}" onblur="upd('${r.id}','item',this.value)" placeholder="Item"></td>
          <td><input value="${(r.supplier&&r.supplier.name)||r.supplierName||''}" onblur="upd('${r.id}','supplier/name',this.value)" placeholder="Fornecedor"></td>
          <td>
            <div class="moneywrap">
              <span class="rs">R$</span>
              <input value="${(r.value||0)}" onblur="updNum('${r.id}','value',this.value)" placeholder="0,00">
            </div>
          </td>
          <td><input value="${(r.expectedDate||'')}" onblur="upd('${r.id}','expectedDate',this.value)" placeholder="dd/mm/aaaa"></td>
          <td class="act">
            ${st==='authorized'
              ? `<button class="buyBtn" onclick="buy('${r.id}')">Comprar</button>`
              : (st==='purchased'
                  ? `<button class="recvBtn" onclick="recv('${r.id}')">Entrada</button>`
                  : `<span class="badge finalizado">Finalizado</span>`
                )
            }
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Listener
    db.ref('purchaseRequests').on('value', snap=>{
      const val = snap.val() || {};
      reqs = Object.keys(val).map(id=>({id, ...val[id]}))
        .filter(r => (r.status==='authorized' || r.status==='purchased' || r.status==='received'));
      render();
    });
  </script>
</body>
</html>
