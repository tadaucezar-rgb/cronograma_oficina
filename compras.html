<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Compras - Execução</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{margin:0;font-family:'Orbitron',Arial,sans-serif;background:radial-gradient(circle at top,#0a0a0a,#000);color:#00e5ff;}
header{padding:14px;background:linear-gradient(90deg,#bdbdbd,#e0e0e0,#bdbdbd);color:#000;font-weight:900;text-align:center;}
.container{padding:14px;max-width:1200px;margin:auto;}
.card{background:rgba(0,0,0,.78);border-radius:18px;padding:16px;border:2px solid rgba(0,229,255,.22);box-shadow:0 0 26px rgba(0,229,255,.22);margin-bottom:12px;}
h2{margin-top:0;color:#ff3d00;text-align:center;}
table{width:100%;border-collapse:collapse;font-size:.85rem;}
th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.15);text-align:left;vertical-align:top;}
input{width:100%;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.08);color:#fff;font-family:'Orbitron';}
button{padding:8px 12px;border-radius:12px;border:none;font-family:'Orbitron',Arial,sans-serif;font-weight:900;cursor:pointer;white-space:nowrap;}
.btn-ok{background:linear-gradient(90deg,#00c853,#64dd17);color:#000;}
.btn-blue{background:linear-gradient(90deg,#2979ff,#00e5ff);color:#000;}
.small{font-size:.75rem;opacity:.8;}
.muted{opacity:.75;}
</style>
</head>

<body>
<header>Setor de Compras</header>

<div class="container">
  <div class="card">
    <h2>Compras Autorizadas</h2>
    <table>
      <thead>
        <tr>
          <th>Solicitação</th>
          <th>Item</th>
          <th>Fornecedor</th>
          <th>Valores</th>
          <th>Previsão de entrega</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
    <div class="small muted" style="margin-top:10px;">
      Mostra itens com status <b>authorized</b> (autorizado) e <b>purchased</b> (comprado).<br>
      Compatível com registros antigos (não exibe “undefined”).
    </div>
  </div>
</div>

<script>
const firebaseConfig={
  apiKey:"AIzaSyBPz4aSee-kQY5hwlyzEw_4Jv3gGKL9iHY",
  authDomain:"tmg-painel.firebaseapp.com",
  databaseURL:"https://tmg-painel-default-rtdb.firebaseio.com",
  projectId:"tmg-painel",
  storageBucket:"tmg-painel.firebasestorage.app",
  messagingSenderId:"877912378151",
  appId:"1:877912378151:web:88af3a4f8f551acd603702"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

function fmt(ts){
  if(!ts) return "-";
  return new Date(ts).toLocaleString("pt-BR");
}

// ===== Compatibilidade de campos (antigos/novos) =====
function getMember(r){
  return r.member || r.requestedBy || r.solicitadoPor || r.solicitante || "-";
}
function getCost(r){
  return r.cost || r.centroCusto || r.costCenter || r.cc || "-";
}
function getItem(r){
  return r.item || r.description || r.descricao || "-";
}
function getQty(r){
  const q = (typeof r.qty === "number" && isFinite(r.qty)) ? r.qty : (isFinite(Number(r.qty)) ? Number(r.qty) : 0);
  const u = r.unit || r.un || r.unidade || "";
  return `${q} ${u}`.trim();
}
function getRequestedAt(r){
  return r.requestedAt || r.createdAt || r.created || r.ts || null;
}

// datetime-local helper (LOCAL, não UTC)
function pad2(n){ return String(n).padStart(2,"0"); }
function msToLocalInput(ms){
  if(!ms) return "";
  const d = new Date(ms);
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}
function localInputToMs(v){
  if(!v) return null;
  // v: YYYY-MM-DDTHH:MM (local)
  const m=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})$/.exec(v);
  if(!m) return null;
  return new Date(Number(m[1]), Number(m[2])-1, Number(m[3]), Number(m[4]), Number(m[5]), 0, 0).getTime();
}

db.ref("purchaseRequests").on("value",snap=>{
  const data=snap.val()||{};
  const tbody=document.getElementById("rows");
  tbody.innerHTML="";

  let count=0;

  Object.entries(data).forEach(([id,r])=>{
    const st = (r.status||"");
    if(st!=="authorized" && st!=="purchased") return;

    count++;

    const member = getMember(r);
    const cost = getCost(r);
    const item = getItem(r);
    const qtd = getQty(r);
    const reqAt = getRequestedAt(r);

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>
        <b>${escapeHtml(String(member))}</b><br>
        <span class="small">${fmt(reqAt)}</span><br>
        <span class="small">${escapeHtml(String(cost))}</span>
      </td>

      <td>
        ${escapeHtml(String(item))}<br>
        <span class="small">${escapeHtml(String(qtd))}</span>
        ${r.obs ? `<div class="small muted" style="margin-top:6px;">Obs: ${escapeHtml(String(r.obs))}</div>` : ``}
      </td>

      <td>
        <input placeholder="Fornecedor" value="${escapeAttr(r.supplier?.name||"")}" onblur="upd('${id}','supplier/name',this.value)">
        <input placeholder="Contato" value="${escapeAttr(r.supplier?.contact||"")}" onblur="upd('${id}','supplier/contact',this.value)">
        <input placeholder="Link" value="${escapeAttr(r.supplier?.link||"")}" onblur="upd('${id}','supplier/link',this.value)">
      </td>

      <td style="min-width:170px;">
        <input type="number" step="any" placeholder="Valor total" value="${escapeAttr(r.total??"")}" onblur="updNumber('${id}','total',this.value)">
        ${r.total ? `<div class="small muted" style="margin-top:6px;">Total: R$ ${escapeHtml(String(r.total))}</div>` : ``}
      </td>

      <td style="min-width:240px;">
        <input type="datetime-local" value="${escapeAttr(msToLocalInput(r.expectedDelivery))}"
               onblur="updExpected('${id}', this.value)">
        ${r.expectedDelivery?'<div class="small">'+fmt(r.expectedDelivery)+'</div>':''}
      </td>

      <td>
        ${st==="authorized"?
          `<button class="btn-blue" onclick="markPurchased('${id}')">Comprar</button>`:
          `<button class="btn-ok" onclick="markReceived('${id}')">Dar entrada</button>`
        }
      </td>
    `;
    tbody.appendChild(tr);
  });

  if(count===0){
    const tr=document.createElement("tr");
    tr.innerHTML = `<td colspan="6" class="small">Nenhuma compra autorizada no momento.</td>`;
    tbody.appendChild(tr);
  }
});

// Multi-path update (com /) funciona no RTDB
function upd(id,path,val){
  const obj={};
  obj[path]=val;
  db.ref("purchaseRequests/"+id).update(obj);
}

function updNumber(id,path,v){
  const n = Number(v);
  upd(id, path, (isFinite(n) && v!=="" ? n : null));
}

function updExpected(id,v){
  const ms = localInputToMs(v);
  upd(id, "expectedDelivery", ms);
}

function markPurchased(id){
  db.ref("purchaseRequests/"+id).update({
    status:"purchased",
    purchasedAt:Date.now()
  });
}

function markReceived(id){
  db.ref("purchaseRequests/"+id).update({
    status:"received",
    receivedAt:Date.now()
  });
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}
function escapeAttr(s){
  // para value=""
  return escapeHtml(s).replace(/\n/g," ");
}
</script>
</body>
</html>
