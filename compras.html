<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Compras</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{
  margin:0;
  font-family:'Orbitron',Arial,sans-serif;
  background:#000;
  color:#00e5ff;
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px 16px;
  background:#dcdcdc;
  color:#000;
  font-weight:900;
}
header img{height:36px}
.wrap{padding:14px;max-width:1200px;margin:auto}
.card{
  background:rgba(0,0,0,.8);
  border-radius:18px;
  padding:16px;
  border:2px solid rgba(0,229,255,.22);
}
.filters{display:flex;gap:10px;margin-bottom:14px}
.fbtn{
  padding:6px 14px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.25);
  background:rgba(255,255,255,.1);
  color:#fff;
  cursor:pointer;
  font-weight:800;
}
.fbtn.active{
  background:#00c853;
  color:#000;
}

table{width:100%;border-collapse:collapse;font-size:.82rem}
th,td{
  padding:10px;
  border-bottom:1px solid rgba(255,255,255,.15);
}
th{text-transform:uppercase;font-size:.7rem}

input{
  width:100%;
  padding:7px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,.25);
  background:rgba(255,255,255,.1);
  color:#fff;
  font-family:'Orbitron';
}

.money{
  display:flex;
  align-items:center;
  background:rgba(255,255,255,.1);
  border-radius:10px;
  overflow:hidden;
}
.money span{
  padding:7px 10px;
  background:rgba(0,0,0,.4);
  border-right:1px solid rgba(255,255,255,.2);
}

button{
  padding:8px 12px;
  border-radius:12px;
  border:none;
  font-weight:900;
  cursor:pointer;
  font-family:'Orbitron';
}
.buy{background:#00c853;color:#000}
.recv{background:#2979ff;color:#000}

.badge{
  padding:6px 12px;
  border-radius:999px;
  font-weight:900;
  background:#9e9e9e;
  color:#000;
}
</style>
</head>

<body>
<header>
  <img src="logo_tmg_clean.png">
  <div>Compras / Serviços</div>
</header>

<div class="wrap">
<div class="card">

  <!-- ✅ FILTROS POR STATUS -->
  <div class="filters">
    <button class="fbtn active" onclick="setFilter('all',this)">Todos</button>
    <button class="fbtn" onclick="setFilter('authorized',this)">Comprar</button>
    <button class="fbtn" onclick="setFilter('purchased',this)">Entrada</button>
    <button class="fbtn" onclick="setFilter('received',this)">Finalizado</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Solicitante</th>
        <th>Item</th>
        <th>Fornecedor</th>
        <th>Valor</th>
        <th>Previsão</th>
        <th>Ação</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

</div>
</div>

<script>
const firebaseConfig={
  apiKey:"AIzaSyBPz4aSee-kQY5hwlyzEw_4Jv3gGKL9iHY",
  databaseURL:"https://tmg-painel-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

let data=[], filter="all";

function setFilter(f,btn){
  filter=f;
  document.querySelectorAll(".fbtn").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  render();
}

db.ref("purchaseRequests").on("value",snap=>{
  data=Object.entries(snap.val()||{}).map(([id,r])=>({id,...r}));
  render();
});

function render(){
  const tbody=document.getElementById("tbody");
  tbody.innerHTML="";
  data.forEach(r=>{
    if(filter!=="all" && r.status!==filter) return;

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${r.requestedBy||"-"}</td>

      <td>
        <input value="${esc(r.item||"")}"
          onblur="upd('${r.id}','item',this.value)">
      </td>

      <td>
        <input value="${esc(r.supplier?.name||"")}"
          onblur="updNested('${r.id}','supplier/name',this.value)">
      </td>

      <td>
        <div class="money">
          <span>R$</span>
          <input type="number" value="${r.total||""}"
            onblur="updNum('${r.id}','total',this.value)">
        </div>
      </td>

      <td>
        <input type="date"
          value="${r.expectedDelivery?new Date(r.expectedDelivery).toISOString().slice(0,10):""}"
          onblur="updDate('${r.id}','expectedDelivery',this.value)">
      </td>

      <td>
        ${r.status==="authorized"?`<button class="buy" onclick="buy('${r.id}')">Comprar</button>`:""}
        ${r.status==="purchased"?`<button class="recv" onclick="recv('${r.id}')">Entrada</button>`:""}
        ${r.status==="received"?`<span class="badge">Finalizado</span>`:""}
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function upd(id,k,v){ db.ref("purchaseRequests/"+id).update({[k]:(v||"").trim()}); }
function updNested(id,path,val){
  const o={},p=path.split("/");
  let r=o;
  p.slice(0,-1).forEach(k=>r=r[k]=r[k]||{});
  r[p[p.length-1]]=val;
  db.ref("purchaseRequests/"+id).update(o);
}
function updNum(id,k,v){ db.ref("purchaseRequests/"+id).update({[k]:Number(v||0)}); }
function updDate(id,k,v){ db.ref("purchaseRequests/"+id).update({[k]:v?new Date(v).getTime():null}); }
function buy(id){ db.ref("purchaseRequests/"+id).update({status:"purchased"}); }
function recv(id){ db.ref("purchaseRequests/"+id).update({status:"received"}); }
function esc(s){return String(s).replaceAll('"','&quot;')}
</script>
</body>
</html>
