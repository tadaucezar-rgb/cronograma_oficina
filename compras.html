<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Compras / Serviços</title>
  <style>
    :root{
      --c-bg:#000;
      --c-cyan:#00e5ff;
      --c-green:#00ff66;
      --c-orange:#ff6a00;
      --c-blue:#2979ff;
      --c-card:#0a0a0a;
      --c-line:#0a7078;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: "Segoe UI", Tahoma, sans-serif;
      color: var(--c-cyan);
      background: radial-gradient(ellipse at top, #111 0%, #000 60%);
      min-height:100vh;
    }
    header{
      height:78px;
      background: linear-gradient(#ddd,#bfbfbf);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 26px;
      color:#111;
      font-weight:700;
      letter-spacing:.5px;
      border-bottom: 2px solid #222;
    }
    header .title{
      font-size:22px;
    }
    header .right{
      font-size:22px;
    }
    .wrap{
      max-width:1400px;
      margin:46px auto;
      padding:0 14px;
    }
    .card{
      background:rgba(0,0,0,.78);
      border:2px solid var(--c-line);
      border-radius:18px;
      padding:20px 18px 26px;
      box-shadow:0 0 30px rgba(0,229,255,.12);
    }
    .filters{
      display:flex;
      gap:12px;
      margin:0 0 16px;
      flex-wrap:wrap;
      align-items:center;
    }
    .filters button{
      border:1px solid rgba(0,229,255,.35);
      background:rgba(255,255,255,.08);
      color:#fff;
      padding:8px 16px;
      border-radius:16px;
      cursor:pointer;
      font-weight:700;
      letter-spacing:.3px;
      box-shadow: inset 0 0 10px rgba(0,229,255,.08);
    }
    .filters button.active{
      background: linear-gradient(#1aff6d,#00c853);
      color:#000;
      border-color: rgba(0,0,0,.25);
    }
    h1{
      margin:0 0 16px;
      color:var(--c-orange);
      text-align:center;
      font-size:44px;
      letter-spacing:1px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
    }
    td:last-child{white-space:nowrap}
    thead th{
      font-size:13px;
      letter-spacing:1.2px;
      color:var(--c-cyan);
      text-transform:uppercase;
      padding:10px 8px;
      border-bottom:1px solid rgba(0,229,255,.18);
    }
    tbody td{
      padding:12px 8px;
      border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align:top;
      color:var(--c-cyan);
      font-size:16px;
    }
    .muted{opacity:.7}
    .name{
      text-transform:uppercase;
      letter-spacing:.8px;
    }
    .dt{
      line-height:1.1;
      white-space:nowrap;
    }

    .inp{
      width:100%;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.12);
      color:#eaeaea;
      padding:8px 10px;
      border-radius:12px;
      outline:none;
      font-size:14px;
      box-shadow: inset 0 0 12px rgba(0,0,0,.35);
    }
    .inp:focus{
      border-color: rgba(0,229,255,.5);
      box-shadow: 0 0 0 2px rgba(0,229,255,.12), inset 0 0 12px rgba(0,0,0,.35);
    }

    .money{
      display:flex;
      width:100%;
      gap:6px;
      align-items:center;
    }
    .money .prefix{
      background:rgba(0,229,255,.18);
      border:1px solid rgba(0,229,255,.25);
      color:var(--c-cyan);
      padding:8px 9px;
      border-radius:12px;
      font-weight:800;
      letter-spacing:.2px;
      min-width:44px;
      text-align:center;
    }

    .btn{
      border:none;
      border-radius:14px;
      padding:9px 14px;
      font-weight:900;
      letter-spacing:.4px;
      cursor:pointer;
      box-shadow:0 0 18px rgba(0,0,0,.25);
    }
    .buy{background:#00c853;color:#000;display:block;width:100%;text-align:center;white-space:nowrap;box-sizing:border-box}
    .recv{background:#2979ff;color:#000;display:block;width:100%;text-align:center;white-space:nowrap;box-sizing:border-box}
    .badge{display:block;width:100%;text-align:center;white-space:nowrap;box-sizing:border-box;padding:6px 10px;border-radius:14px;font-weight:900;letter-spacing:.4px;background:rgba(255,255,255,.18);color:#111;border:1px solid rgba(255,255,255,.25)}
    .badge.done{background:rgba(180,0,255,.18);color:#fff;border-color:rgba(180,0,255,.35)} /* finalizado com cor diferente */

    .supplierWrap{
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    @media (max-width: 980px){
      h1{font-size:34px}
      header{height:auto; padding:12px 14px}
      table{font-size:14px}
      thead{display:none}
      table, tbody, tr, td{display:block; width:100%}
      tbody td{border-bottom:none}
      tr{border-bottom:1px solid rgba(255,255,255,.12); padding:10px 0}
      .rowlabel{
        display:block;
        font-size:11px;
        text-transform:uppercase;
        opacity:.8;
        margin:0 0 4px;
        letter-spacing:1px;
      }
      .money{max-width:320px}
      .filters{justify-content:center}
    }
  </style>
</head>
<body>
<header>
  <div class="title">TMG Racing</div>
  <div class="right">Compras / Serviços</div>
</header>

<div class="wrap">
  <div class="card">
    <div class="filters">
      <button id="f_all" class="active" onclick="setFilter('all')">Todos</button>
      <button id="f_buy" onclick="setFilter('purchased')">Comprar</button>
      <button id="f_recv" onclick="setFilter('received')">Entrada</button>
      <button id="f_done" onclick="setFilter('finalized')">Finalizado</button>
    </div>

    <table>
      <colgroup>
        <col style="width:9%">
        <col style="width:9%">
        <col style="width:22%">
        <col style="width:6%">
        <col style="width:6%">
        <col style="width:18%">
        <col style="width:12%">
        <col style="width:12%">
        <col style="width:6%">
      </colgroup>
      <thead>
        <tr>
          <th>Solicitante</th>
          <th>Data<br>Solicitação</th>
          <th>Item</th>
          <th>Qtd</th>
          <th>Unidade</th>
          <th>Fornecedor</th>
          <th>Valor</th>
          <th>Previsão</th>
          <th>Ação</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
  // --- Firebase config (mantido como estava no seu arquivo) ---
  const firebaseConfig = {
    apiKey: "AIzaSyDUMMY",
    authDomain: "DUMMY.firebaseapp.com",
    databaseURL: "https://DUMMY.firebaseio.com",
    projectId: "DUMMY",
    storageBucket: "DUMMY.appspot.com",
    messagingSenderId: "DUMMY",
    appId: "1:000000000:web:000000"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // --- estado ---
  let currentFilter = 'all';
  let allRows = [];

  function setActiveBtn(){
    document.querySelectorAll('.filters button').forEach(b=>b.classList.remove('active'));
    if(currentFilter==='all') document.getElementById('f_all').classList.add('active');
    if(currentFilter==='purchased') document.getElementById('f_buy').classList.add('active');
    if(currentFilter==='received') document.getElementById('f_recv').classList.add('active');
    if(currentFilter==='finalized') document.getElementById('f_done').classList.add('active');
  }

  function setFilter(f){
    currentFilter = f;
    setActiveBtn();
    render();
  }

  function fmtDateTime(ts){
    if(!ts) return '-';
    const d = (typeof ts === 'number') ? new Date(ts) : new Date(ts);
    if(isNaN(d.getTime())) return '-';
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yyyy = d.getFullYear();
    const hh = String(d.getHours()).padStart(2,'0');
    const mi = String(d.getMinutes()).padStart(2,'0');
    return `${dd}/${mm}/${yyyy}<br>${hh}:${mi}`;
  }

  // --- autocomplete simples (mantido conforme sua versão) ---
  const suppliers = {}; // nome -> contato
  function loadSuppliers(){
    db.ref('fornecedores').on('value', snap=>{
      const v = snap.val() || {};
      Object.keys(v).forEach(k=>{
        const obj = v[k] || {};
        if(obj.nome) suppliers[obj.nome] = obj.contato || '';
      });
    });
  }

  function buildSupplierDatalist(){
    let dl = document.getElementById('dl_suppliers');
    if(!dl){
      dl = document.createElement('datalist');
      dl.id = 'dl_suppliers';
      document.body.appendChild(dl);
    }
    dl.innerHTML = '';
    Object.keys(suppliers).sort().forEach(name=>{
      const opt = document.createElement('option');
      opt.value = name;
      dl.appendChild(opt);
    });
  }

  function render(){
    const tbody = document.getElementById('tbody');
    tbody.innerHTML = '';

    const rows = allRows.filter(r=>{
      if(currentFilter==='all') return true;
      return (r.status === currentFilter);
    });

    if(rows.length===0){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="9" class="muted">Nenhum registro</td>`;
      tbody.appendChild(tr);
      return;
    }

    buildSupplierDatalist();

    rows.forEach(r=>{
      const tr = document.createElement('tr');

      const solicitante = r.solicitante || '-';
      const dtSolic = fmtDateTime(r.createdAt || r.timestamp || r.dataSolicitacao);

      const itemInput = `<input class="inp" value="${escapeHtml(r.item||'')}"
        onblur="updateField('${r._key}','item',this.value)" />`;

      const qtdInput = `<input class="inp" value="${escapeAttr(r.qtd||'')}"
        onblur="updateField('${r._key}','qtd',this.value)" />`;

      const unInput = `<input class="inp" value="${escapeAttr(r.unidade||'')}"
        onblur="updateField('${r._key}','unidade',this.value)" />`;

      const fornecedorInput = `
        <div class="supplierWrap">
          <input class="inp" list="dl_suppliers" placeholder=""
            value="${escapeAttr(r.fornecedor||'')}"
            oninput="onSupplierInput('${r._key}', this)"
            onblur="updateField('${r._key}','fornecedor',this.value)" />
          <input class="inp" placeholder="Contato do fornecedor"
            value="${escapeAttr(r.contatoFornecedor||'')}"
            onblur="updateField('${r._key}','contatoFornecedor',this.value)" />
        </div>
      `;

      const valorInput = `
        <div class="money">
          <div class="prefix">R$</div>
          <input class="inp" value="${escapeAttr(r.valor||'')}"
            onblur="updateField('${r._key}','valor',this.value)" />
        </div>
      `;

      const prevInput = `<input class="inp" type="datetime-local"
        value="${toLocalDT(r.previsao)}"
        onblur="updateField('${r._key}','previsao',fromLocalDT(this.value))" />`;

      const actionCell = buildAction(r);

      tr.innerHTML = `
        <td class="name">${escapeHtml(solicitante)}</td>
        <td class="dt">${dtSolic}</td>
        <td>${itemInput}</td>
        <td>${qtdInput}</td>
        <td>${unInput}</td>
        <td>${fornecedorInput}</td>
        <td>${valorInput}</td>
        <td>${prevInput}</td>
        <td>${actionCell}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function buildAction(r){
    if(r.status === 'purchased'){
      return `<button class="btn recv" onclick="setStatus('${r._key}','received')">Entrada</button>`;
    }
    if(r.status === 'received'){
      return `<span class="badge done">Finalizado</span>`;
    }
    if(r.status === 'finalized'){
      return `<span class="badge done">Finalizado</span>`;
    }
    return `<button class="btn buy" onclick="setStatus('${r._key}','purchased')">Comprar</button>`;
  }

  function setStatus(key, status){
    db.ref('requisicoes/'+key).update({status});
  }

  function updateField(key, field, value){
    const obj = {};
    obj[field] = value;
    db.ref('requisicoes/'+key).update(obj);
  }

  function onSupplierInput(key, el){
    const name = el.value || '';
    const contato = suppliers[name] || '';
    // não sobrescreve se usuário já digitou manualmente algo diferente
    const tr = el.closest('tr');
    if(!tr) return;
    const contatoInp = tr.querySelector('input[placeholder="Contato do fornecedor"]');
    if(contatoInp && (!contatoInp.value || contatoInp.value===suppliers[contatoInp.value])){
      if(contato) contatoInp.value = contato;
    }
  }

  function toLocalDT(v){
    if(!v) return '';
    const d = (typeof v === 'number') ? new Date(v) : new Date(v);
    if(isNaN(d.getTime())) return '';
    const pad = n => String(n).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }
  function fromLocalDT(v){
    if(!v) return null;
    const d = new Date(v);
    if(isNaN(d.getTime())) return null;
    return d.getTime();
  }

  function escapeHtml(str){
    return String(str||'').replace(/[&<>"']/g, s=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[s]));
  }
  function escapeAttr(str){
    return String(str||'').replace(/"/g,'&quot;');
  }

  function listen(){
    db.ref('requisicoes').on('value', snap=>{
      const v = snap.val() || {};
      const arr = [];
      Object.keys(v).forEach(k=>{
        arr.push({...v[k], _key:k});
      });
      allRows = arr.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
      render();
    });
  }

  loadSuppliers();
  listen();
</script>
</body>
</html>
