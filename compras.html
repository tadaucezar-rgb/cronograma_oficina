<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Compras</title>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:'Orbitron',Arial,sans-serif;background:radial-gradient(circle at top,#0a0a0a,#000);color:#00e5ff}
header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:linear-gradient(90deg,#bdbdbd,#e0e0e0,#bdbdbd);color:#000;font-weight:900}
header img{height:36px}
.wrap{padding:14px;max-width:1200px;margin:auto}
.card{background:rgba(0,0,0,.78);border-radius:18px;padding:16px;border:2px solid rgba(0,229,255,.22);box-shadow:0 0 26px rgba(0,229,255,.22)}
.filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.fbtn{padding:6px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.08);color:#fff;font-weight:800;cursor:pointer}
.fbtn.active{background:linear-gradient(90deg,#00c853,#64dd17);color:#000}
table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:.82rem}
th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.15);vertical-align:top}
th{text-transform:uppercase;font-size:.7rem}
.money{display:flex;align-items:center;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.2);border-radius:10px;overflow:hidden}
.money span{padding:8px 10px;font-weight:900;background:rgba(0,0,0,.35);border-right:1px solid rgba(255,255,255,.15)}
.money input{border:none;background:transparent;padding:8px;color:#fff;width:100%;font-family:'Orbitron'}
input,select{width:100%;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.08);color:#fff}
button{padding:8px 12px;border-radius:12px;border:none;font-family:'Orbitron';font-weight:900;cursor:pointer}
.buy{background:#00c853;color:#000}
.recv{background:#2979ff;color:#000}
.overdue{background:rgba(255,23,68,.18)}
.badge{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:900;border:1px solid rgba(255,255,255,.22);background:rgba(255,255,255,.08);color:#fff}
.badge.finalizado{background:linear-gradient(90deg,#7b2ff7,#b04bff);color:#fff;border:1px solid rgba(176,75,255,.35)}
</style>
</head>

<body>
<header>
  <img src="logo_tmg_clean.png">
  <div>Compras / Serviços</div>
</header>

<div class="wrap">
  <div class="card">
    <div class="filters">
    <button class="pill active" id="f_all" onclick="setFilter('all')">Todos</button>
    <button class="pill" id="f_buy" onclick="setFilter('buy')">Comprar</button>
    <button class="pill" id="f_entry" onclick="setFilter('entry')">Entrada</button>
    <button class="pill" id="f_done" onclick="setFilter('done')">Finalizado</button>
  </div>

    <table>
      <thead>
        <tr>
          <th>Solicitante</th>
          <th>Item</th>
          <th>Fornecedor</th>
          <th>Valor</th>
          <th>Previsão</th>
          <th>Ação</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script>
function escAttr(v){return String(v??'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

const firebaseConfig={
  apiKey:"AIzaSyBPz4aSee-kQY5hwlyzEw_4Jv3gGKL9iHY",
  databaseURL:"https://tmg-painel-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

let data=[], filter="all";

function setFilter(f){
  filter = f;
  const ids = ['f_all','f_buy','f_entry','f_done'];
  ids.forEach(id=>{ const el=document.getElementById(id); if(el) el.classList.remove('active'); });
  const map = {all:'f_all', buy:'f_buy', entry:'f_entry', done:'f_done'};
  const act = document.getElementById(map[f] || 'f_all');
  if(act) act.classList.add('active');
  render();
}

function isToday(ms){
  if(!ms) return false;
  const d=new Date(ms), n=new Date();
  return d.toDateString()===n.toDateString();
}
function isWeek(ms){
  if(!ms) return false;
  const d=new Date(ms), n=new Date();
  const diff=(d-n)/(1000*60*60*24);
  return diff>=0 && diff<=7;
}

db.ref("purchaseRequests").on("value",snap=>{
  data=Object.entries(snap.val()||{}).map(([id,r])=>({id,...r}));
  render();
});

function render(){
  const tbody = document.querySelector('#tbl tbody');
  if(!tbody) return;

  const list = reqs.filter(r=>{
    const st = String(r.status || 'authorized').toLowerCase();
    if(filter==='buy') return st==='authorized';
    if(filter==='entry') return st==='purchased';
    if(filter==='done') return st==='received';
    return true;
  });

  tbody.innerHTML = '';
  if(list.length===0){
    const tr=document.createElement('tr');
    tr.innerHTML = '<td colspan="7" class="muted">Nenhum registro</td>';
    tbody.appendChild(tr);
    return;
  }

  list.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));

  list.forEach(r=>{
    const st = String(r.status || 'authorized').toLowerCase();
    const solicitante = r.requestedBy || r.member || '-';
    const dtVal = r.expectedDelivery ? new Date(r.expectedDelivery).toISOString().slice(0,16) : '';
    const action = (st==='received')
      ? `<span class="badge finalizado">Finalizado</span>`
      : (st==='purchased')
        ? `<button class="btn entrada" onclick="recv('${r.id}')">Entrada</button>`
        : `<button class="btn comprar" onclick="buy('${r.id}')">Comprar</button>`;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escAttr(solicitante)}</td>
      <td><input class="inp iteminp" value="${escAttr(r.item||'')}" placeholder="Item" data-id="${r.id}"></td>
      <td><input class="inp" value="${escAttr(r.supplier||'')}" placeholder="Fornecedor" onblur="upd('${r.id}','supplier',this.value.trim())"></td>
      <td><div class="money"><span>R$</span><input class="inp" type="number" step="0.01" value="${escAttr(r.total||'')}" placeholder="0,00" onblur="updNum('${r.id}','total',this.value)"></div></td>
      <td><input class="inp" type="datetime-local" value="${escAttr(dtVal)}" onblur="updDate('${r.id}','expectedDelivery',this.value)"></td>
      <td>${action}</td>
    `;
    tbody.appendChild(tr);
  });

  // editar item
  document.querySelectorAll('.iteminp').forEach(inp=>{
    inp.onchange = ()=>{
      const id = inp.getAttribute('data-id');
      if(!id) return;
      upd(id,'item',(inp.value||'').trim());
    };
  });
}


function upd(id,path,val){
  const o={}; let ref=o; const p=path.split("/");
  p.slice(0,-1).forEach(k=>ref=ref[k]=ref[k]||{});
  ref[p[p.length-1]]=val;
  db.ref("purchaseRequests/"+id).update(o);
}
function updNum(id,k,v){ db.ref("purchaseRequests/"+id).update({[k]:Number(v||0)}); }
function updDate(id,k,v){ db.ref("purchaseRequests/"+id).update({[k]: v ? new Date(v).getTime() : null}); }
function buy(id){ db.ref("purchaseRequests/"+id).update({status:"purchased",purchasedAt:Date.now()}); }
function recv(id){ db.ref("purchaseRequests/"+id).update({status:"received",receivedAt:Date.now()}); }
</script>
</body>
</html>
