<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Admin - Cronograma Oficina</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<style>
html,body{margin:0;background:radial-gradient(circle at top,#0a0a0a,#000);font-family:'Orbitron',Arial,sans-serif;color:#00e5ff;}
header{display:flex;align-items:center;justify-content:space-between;padding:14px 26px;background:linear-gradient(90deg,#bdbdbd,#e0e0e0,#bdbdbd);box-shadow:0 0 20px rgba(0,0,0,.45);}
.header-left{display:flex;align-items:center;gap:16px;font-size:1.7rem;font-weight:800;letter-spacing:2px;color:#000;text-transform:uppercase;}
.header-left img{height:90px;background:none;padding:0;border:none;filter:drop-shadow(0 0 12px rgba(0,0,0,.6));}

.container{padding:16px;display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.panel{background:rgba(0,0,0,.78);border-radius:18px;padding:14px;border:2px solid rgba(0,229,255,.22);box-shadow:0 0 26px rgba(0,229,255,.25);overflow:hidden;}
.full{grid-column:1/3}
h2{margin:0 0 10px 0;text-align:center;color:#ff3d00;text-transform:uppercase;letter-spacing:2px;font-size:1.1rem;}

label{display:block;margin-top:10px;font-size:.85rem;color:rgba(255,255,255,.85);letter-spacing:1px}
input,select,button{width:100%;padding:10px;border-radius:12px;border:none;font-family:'Orbitron',Arial,sans-serif;margin-top:6px;box-sizing:border-box;}
input,select{background:rgba(255,255,255,.08);color:#fff;border:1px solid rgba(0,229,255,.25);outline:none;}
button{margin-top:12px;font-weight:900;cursor:pointer;letter-spacing:1px;}
.btn-green{background:linear-gradient(90deg,#00c853,#64dd17);color:#000}
.btn-yellow{background:linear-gradient(90deg,#ffea00,#f9a825);color:#000}
.btn-red{background:linear-gradient(90deg,#b71c1c,#ff1744);color:#fff}
.btn-muted{background:rgba(255,255,255,.10);color:#fff;border:1px solid rgba(255,255,255,.15)}
.hint{margin-top:8px;color:rgba(255,255,255,.65);font-size:.8rem;line-height:1.35}

table{width:100%;border-collapse:collapse;font-size:.85rem;}
th,td{padding:10px 8px;border-bottom:1px solid rgba(0,229,255,.2);vertical-align:top;}
th{color:#fff;text-transform:uppercase;font-size:.72rem;letter-spacing:1px;background:rgba(255,0,0,.12);}

.actions{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;}
.action-btn{width:auto;padding:10px 12px;border-radius:12px;border:none;font-family:'Orbitron',Arial,sans-serif;font-weight:900;cursor:pointer;white-space:nowrap;}

.badge{display:inline-block;padding:6px 10px;border-radius:999px;font-size:.72rem;font-weight:900;text-transform:uppercase;letter-spacing:1px;white-space:nowrap;}
.todo{background:#ff1744;color:#fff}
.doing{background:#ffea00;color:#000}
.pending{background:#00e5ff;color:#000}
.done{background:#00c853;color:#000}

.p-high{background:#ff1744;color:#fff}
.p-med{background:#ffea00;color:#000}
.due-over{background:#ff1744;color:#fff}
.due-today{background:#ff1744;color:#fff}
.due-soon{background:#ffea00;color:#000}
.due-warn{background:#00e5ff;color:#000}

.p-low{background:#64ffda;color:#000}

/* Equipe */
.people-grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px;max-height:360px;overflow:auto;padding-right:6px;}
.person-card{border:1px solid rgba(0,229,255,.18);border-radius:14px;padding:10px;background:rgba(255,255,255,.03);}
.person-top{display:flex;align-items:center;justify-content:space-between;gap:10px;}
.person-name{color:#fff;font-weight:900;letter-spacing:1px;text-transform:uppercase;font-size:.95rem;}
.person-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;}
.small-link{color:rgba(255,255,255,.75);font-size:.78rem;word-break:break-all;margin-top:6px;}
.qr-wrap{margin-top:10px;display:none;gap:10px;align-items:center;flex-wrap:wrap;}
.qr-box{background:#fff;padding:10px;border-radius:12px;}
.qr-note{color:rgba(255,255,255,.75);font-size:.78rem;line-height:1.35;max-width:360px;}

/* Modais */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;padding:18px;z-index:999;}
.modal{background:rgba(0,0,0,.9);padding:16px;border-radius:18px;border:2px solid rgba(0,229,255,.35);width:100%;max-width:560px;box-shadow:0 0 26px rgba(0,229,255,.22);}
.modal h3{margin:0 0 10px 0;text-align:center;color:#ff3d00;letter-spacing:2px;text-transform:uppercase;}
.modal-actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px;}
.modal-actions .full{grid-column:1/-1}
</style>
</head>

<body>
<header>
  <div class="header-left">
    <img src="logo_tmg_clean.png" alt="TMG">
    Admin Oficina
  </div>
</header>

<div class="container">

  <!-- NOVA TAREFA -->
  <div class="panel">
    <h2>Nova Tarefa</h2>

    <label>Nome</label>
    <input id="taskName" placeholder="Ex: Revisar suspens√£o dianteira">

    <label>Respons√°veis (separar por v√≠rgula)</label>
    <input id="taskPeople" placeholder="Ex: Davi, Jo√£o">

    <label>Status</label>
    <select id="taskStatus">
      <option value="todo">A Fazer</option>
      <option value="doing">Em Andamento</option>
      <option value="pending">Aguardando aprova√ß√£o</option>
      <option value="done">Conclu√≠da</option>
    </select>

    <label>Prioridade</label>
    <select id="taskPriority">
      <option value="high">Alta</option>
      <option value="med" selected>M√©dia</option>
      <option value="low">Baixa</option>
    </select>

    

    <label>Prazo (data e hora)</label>
    <input id="taskDue" type="datetime-local">

<button class="btn-green" onclick="addTask()">Adicionar</button>
    <div class="hint">Dica: use os nomes cadastrados em ‚ÄúEquipe‚Äù para bater certinho no celular.</div>
  </div>

  <!-- DATAS IMPORTANTES -->
  <div class="panel">
    <h2>Datas Importantes</h2>

    <label>T√≠tulo</label>
    <input id="dateTitle" placeholder="Ex: 1¬™ Etapa Curvelo">

    <label>Data</label>
    <input id="dateValue" type="date">

    <button class="btn-green" onclick="addDate()">Adicionar Data</button>

    <div class="hint">Voc√™ pode editar/remover na lista abaixo.</div>

    <div style="margin-top:12px; max-height:360px; overflow:auto; padding-right:6px;">
      <table>
        <thead>
          <tr>
            <th>T√≠tulo</th>
            <th>Data</th>
            <th style="text-align:right;">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="datesTable"></tbody>
      </table>
    </div>
  </div>

  <!-- EQUIPE -->
  <div class="panel">
    <h2>Equipe</h2>

    <label>Nome do membro</label>
    <input id="personName" placeholder="Ex: Davi">

    <button class="btn-green" onclick="addPerson()">Cadastrar</button>

    <div class="hint">
      O celular vai mostrar uma lista com esses nomes (sem digitar).<br>
      Voc√™ tamb√©m pode gerar QR Code individual para abrir direto.
    </div>

    <div class="people-grid" id="peopleList"></div>
  </div>

  <!-- LISTA DE TAREFAS -->
  <div class="panel full">
    <h2>Tarefas</h2>
    <table>
      <thead>
        <tr>
          <th style="width:34%;">Tarefa</th>
          <th style="width:20%;">Respons√°veis</th>
          <th style="width:12%;">Status</th>
          <th style="width:10%;">Prior.</th>
          <th style="width:14%;">Prazo</th>
          <th style="width:24%; text-align:right;">A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="taskTable"></tbody>
    </table>
  </div>

</div>


<!-- MODAL: LOGIN (ADMIN) -->
<div class="modal-bg" id="loginModal">
  <div class="modal">
    <h3>Admin ‚Äî Acesso</h3>
    <div class="hint" style="margin-top:0;">
      Digite o PIN para evitar altera√ß√µes por engano.
    </div>

    <label>PIN</label>
    <input id="pinInput" type="password" inputmode="numeric" placeholder="Ex: 1234" />

    <label style="display:flex;align-items:center;gap:10px;margin-top:12px;">
      <input id="pinRemember" type="checkbox" style="width:auto;margin:0;transform:scale(1.15);" />
      Lembrar neste navegador (12h)
    </label>

    <div class="modal-actions">
      <button class="btn-green full" onclick="checkPin()">Entrar</button>
    </div>

    <div class="hint">
      Dica: voc√™ pode mudar o PIN dentro do arquivo <b>admin.html</b>.
    </div>
  </div>
  <!-- RELAT√ìRIOS -->
  <div class="panel full">
    <h2>Relat√≥rios (Tempo por pessoa)</h2>

    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px;align-items:end;">
      <div>
        <label>De (aprovadas a partir)</label>
        <input id="repFrom" type="date">
      </div>
      <div>
        <label>At√© (aprovadas at√©)</label>
        <input id="repTo" type="date">
      </div>
      <div>
        <label style="display:flex;align-items:center;gap:10px;margin-top:16px;">
          <input id="repSplit" type="checkbox" checked style="width:auto;margin:0;transform:scale(1.2);">
          Dividir tempo entre respons√°veis
        </label>
        <div class="hint" style="margin-top:6px;">
          Se desmarcar, cada respons√°vel ‚Äúleva‚Äù o tempo inteiro da tarefa (pode duplicar).
        </div>
      </div>
      <div>
        <button class="btn-yellow" onclick="exportReportCSV()">‚¨áÔ∏è Exportar CSV</button>
        <button class="btn-muted" onclick="refreshReport()" style="margin-top:10px;">üîÑ Atualizar</button>
      </div>
    </div>

    <div style="margin-top:12px; max-height:420px; overflow:auto; padding-right:6px;">
      <table>
        <thead>
          <tr>
            <th>Pessoa</th>
            <th style="width:14%;">Tarefas</th>
            <th style="width:18%;">Tempo (execu√ß√£o)</th>
            <th style="width:18%;">Tempo m√©dio</th>
            <th style="width:22%;">Lead time (cria√ß√£o‚Üíaprova√ß√£o)</th>
          </tr>
        </thead>
        <tbody id="reportTable"></tbody>
      </table>
    </div>

    <div class="hint" style="margin-top:10px;">
      ‚Ä¢ ‚ÄúTempo (execu√ß√£o)‚Äù = startedAt ‚Üí approvedAt<br>
      ‚Ä¢ ‚ÄúLead time‚Äù = created ‚Üí approvedAt<br>
      ‚Ä¢ S√≥ entra tarefa que estiver <b>Conclu√≠da (aprovada)</b>
    </div>
  </div>

</div>

<!-- MODAL: REABRIR -->
<div class="modal-bg" id="reopenModal">
  <div class="modal">
    <h3>Reabrir tarefa</h3>
    <div class="hint" style="margin-top:0;">Para qual status a tarefa deve voltar?</div>

    <div class="modal-actions">
      <button class="btn-red" onclick="reopenTo('todo')">A Fazer</button>
      <button class="btn-yellow" onclick="reopenTo('doing')">Em Andamento</button>
      <button class="btn-muted full" onclick="closeReopen()">Cancelar</button>
    </div>
  </div>
</div>

<!-- MODAL: EDITAR TAREFA -->
<div class="modal-bg" id="editModal">
  <div class="modal">
    <h3>Editar tarefa</h3>

    <input type="hidden" id="editId">

    <label>Nome</label>
    <input id="editName">

    <label>Respons√°veis (v√≠rgula)</label>
    <input id="editPeople">

    <label>Status</label>
    <select id="editStatus">
      <option value="todo">A Fazer</option>
      <option value="doing">Em Andamento</option>
      <option value="pending">Aguardando aprova√ß√£o</option>
      <option value="done">Conclu√≠da</option>
    </select>

    <label>Prioridade</label>
    <select id="editPriority">
      <option value="high">Alta</option>
      <option value="med">M√©dia</option>
      <option value="low">Baixa</option>
    </select>

    

    <label>Prazo (data e hora)</label>
    <input id="editDue" type="datetime-local">

<div class="modal-actions">
      <button class="btn-green" onclick="saveEdit()">Salvar</button>
      <button class="btn-muted" onclick="closeEdit()">Cancelar</button>
      <button class="btn-red full" onclick="deleteTaskFromModal()">Excluir tarefa</button>
    </div>
  </div>
</div>

<script>
/* ===== COLE SEU FIREBASE CONFIG ===== */
const firebaseConfig = {
  apiKey: "AIzaSyBPz4aSee-kQY5hwlyzEw_4Jv3gGKL9iHY",
  authDomain: "tmg-painel.firebaseapp.com",
  databaseURL: "https://tmg-painel-default-rtdb.firebaseio.com",
  projectId: "tmg-painel",
  storageBucket: "tmg-painel.firebasestorage.app",
  messagingSenderId: "877912378151",
  appId: "1:877912378151:web:88af3a4f8f551acd603702",
  measurementId: "G-EK39245W6K"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ===== Admin PIN (simples) =====
   Troque o valor abaixo.
*/
const ADMIN_PIN = "4032";
const AUTH_KEY = "tmg_admin_auth_until";

function requireAdminAuth(){
  const until = Number(localStorage.getItem(AUTH_KEY) || "0");
  const ok = Date.now() < until;
  if(ok){
    document.getElementById("loginModal").style.display = "none";
    return;
  }
  // bloqueia tela
  document.getElementById("loginModal").style.display = "flex";
  setTimeout(()=>document.getElementById("pinInput")?.focus(), 100);
}
function checkPin(){
  const pin = document.getElementById("pinInput").value.trim();
  if(pin !== ADMIN_PIN) return alert("PIN incorreto.");
  const remember = document.getElementById("pinRemember").checked;
  const ttl = remember ? (12*60*60*1000) : (2*60*60*1000); // 12h ou 2h
  localStorage.setItem(AUTH_KEY, String(Date.now() + ttl));
  document.getElementById("pinInput").value = "";
  document.getElementById("loginModal").style.display = "none";
}


/* ===== Helpers ===== */
function safeText(s){return String(s||"").replace(/</g,"&lt;").replace(/>/g,"&gt;");}
function parsePeople(text){
  const parts=(text||"").split(",").map(s=>s.trim()).filter(Boolean);
  const seen=new Set(); const out=[];
  for(const p of parts){const k=p.toLowerCase(); if(!seen.has(k)){seen.add(k); out.push(p);}}
  return out;
}
function statusLabel(s){
  if(s==="todo") return "A Fazer";
  if(s==="doing") return "Em Andamento";
  if(s==="pending") return "Aguardando aprova√ß√£o";
  if(s==="done") return "Conclu√≠da";
  return s||"";
}
function priorityLabel(p){
  if(p==="high") return "Alta";
  if(p==="med") return "M√©dia";
  return "Baixa";
}
function priorityClass(p){
  if(p==="high") return "p-high";
  if(p==="med") return "p-med";
  return "p-low";
}

/* ===== Datas (prazo) ===== */
function formatBR(ymd){
  const m=/^(\d{4})-(\d{2})-(\d{2})$/.exec(ymd||"");
  if(!m) return "";
  return `${m[3]}/${m[2]}/${m[1]}`;
}

function parseYMD(ymd){
  const m=/^(\d{4})-(\d{2})-(\d{2})$/.exec(ymd||"");
  if(!m) return null;
  const y=Number(m[1]), mo=Number(m[2])-1, d=Number(m[3]);
  return new Date(y, mo, d, 0,0,0,0);
}

function getDueMs(t){
  if(t && typeof t.dueAt === "number" && !isNaN(t.dueAt)) return t.dueAt;
  if(t && typeof t.dueAt === "string" && t.dueAt.trim() && !isNaN(Number(t.dueAt))) return Number(t.dueAt);
  if(t && typeof t.dueLocal === "string" && t.dueLocal.includes("T")){
    const ms=parseDTLocalToMs(t.dueLocal);
    if(ms!=null) return ms;
  }
  if(t && typeof t.dueDate === "string"){
    const d=parseYMD(t.dueDate);
    if(d) return d.getTime();
  }
  return null;
}

function dueInfo(t){
  const ms=getDueMs(t);
  if(ms==null) return {label:"‚Äî", cls:""};
  const nowMs=Date.now();
  const diffMs=ms-nowMs;
  const abs=Math.abs(diffMs);

  const totalMin=Math.floor(abs/(1000*60));
  const days=Math.floor(totalMin/(60*24));
  const hours=Math.floor((totalMin%(60*24))/60);
  const mins=totalMin%60;

  const base = formatBRDateTime(ms);

  if(diffMs < 0){
    // toler√¢ncia: se est√° dentro do mesmo dia, chama "Hoje"
    const withinDay = abs < (1000*60*60*24);
    return {label:`${base} ‚Ä¢ ${withinDay ? "Hoje" : `Atrasado ${days}d ${hours}h`}`, cls:"due-over"};
  }
  if(diffMs <= 1000*60*60*24){
    return {label:`${base} ‚Ä¢ ‚â§24h (${hours}h ${mins}m)`, cls:"due-soon"};
  }
  if(diffMs <= 1000*60*60*24*3){
    return {label:`${base} ‚Ä¢ ${days}d ${hours}h`, cls:"due-warn"};
  }
  return {label: base, cls:""};
}
function renderDueCell(t){
  const {label, cls}=dueInfo(t);
  if(label==="‚Äî") return `<span style="opacity:.65;">‚Äî</span>`;
  return `<span class="badge ${cls}" title="Prazo">${safeText(label)}</span>`;
}


/* ‚úÖ LINK DO QR (CORRIGIDO) ‚Äî sempre vai para equipe.html na mesma pasta */
function equipeBaseUrl(){
  const u = new URL(window.location.href);
  // remove query/hash e garante que aponta para a mesma pasta do site
  u.search = "";
  u.hash = "";

  // pega o diret√≥rio atual e for√ßa equipe.html
  // funciona para /admin, /admin.html, /index.html ou /
  u.pathname = u.pathname.replace(/[^\/]*$/, ""); // fica na pasta
  return u.toString() + "equipe.html";
}

/* ===== TAREFAS ===== */
function addTask(){
  const name=document.getElementById("taskName").value.trim();
  if(!name) return alert("Preencha o nome da tarefa.");

  const people=parsePeople(document.getElementById("taskPeople").value);
  if(!people.length) return alert("Informe pelo menos 1 respons√°vel.");

  const status=document.getElementById("taskStatus").value;
  const priority=document.getElementById("taskPriority").value;
  const dueLocal=document.getElementById("taskDue").value || null;
  const dueAt = dueLocal ? parseDTLocalToMs(dueLocal) : null;
  const dueDate = dueLocal ? dueLocal.slice(0,10) : null;
  const now=Date.now();

  const payload={name, people, status, priority, dueDate, dueLocal, dueAt, created:now, updatedAt:now};
  if(status==="doing") payload.startedAt=now;
  if(status==="done") { payload.startedAt=now; payload.approvedAt=now; payload.durationMs=0; payload.leadTimeMs=0; }

  db.ref("tasks").push(payload);

  document.getElementById("taskName").value="";
  document.getElementById("taskPeople").value="";
  document.getElementById("taskStatus").value="todo";
  document.getElementById("taskPriority").value="med";
  document.getElementById("taskDue").value="";
}

const taskCache={};
let reopenId=null;

function approve(id){
  const now=Date.now();
  const t=taskCache[id]||{};
  const startedAt = t.startedAt || (t.status==="doing" ? now : null);
  const created = t.created || null;

  const update={status:"done", approvedAt:now, updatedAt:now};
  if(startedAt){
    update.durationMs = Math.max(0, now - startedAt);
  }
  if(created){
    update.leadTimeMs = Math.max(0, now - created);
  }
  db.ref("tasks/"+id).update(update);
}

function openReopen(id){
  reopenId=id;
  document.getElementById("reopenModal").style.display="flex";
}
function closeReopen(){
  document.getElementById("reopenModal").style.display="none";
  reopenId=null;
}
function reopenTo(status){
  if(!reopenId) return;
  const now=Date.now();
  const update={status, updatedAt:now};

  if(status==="todo"){
    update.startedAt=null;
    update.approvedAt=null;
    update.durationMs=null;
  }
  if(status==="doing"){
    const t=taskCache[reopenId]||{};
    if(!t.startedAt) update.startedAt=now;
    update.approvedAt=null;
    update.durationMs=null;
  }
  if(status!=="done"){
    update.approvedAt=null;
  }
  db.ref("tasks/"+reopenId).update(update);
  closeReopen();
}

/* Editar tarefa */
function openEdit(id){
  const t=taskCache[id]; if(!t) return;
  document.getElementById("editId").value=id;
  document.getElementById("editName").value=t.name||"";
  document.getElementById("editPeople").value=(t.people||[]).join(", ");
  document.getElementById("editStatus").value=t.status||"todo";
  document.getElementById("editPriority").value=t.priority||"low";
  document.getElementById("editDue").value = t.dueLocal || (t.dueAt ? msToDTLocal(t.dueAt) : (t.dueDate ? (t.dueDate + "T00:00") : ""));
  document.getElementById("editModal").style.display="flex";
}
function closeEdit(){ document.getElementById("editModal").style.display="none"; }
function saveEdit(){
  const id=document.getElementById("editId").value; if(!id) return;
  const name=document.getElementById("editName").value.trim();
  if(!name) return alert("Nome obrigat√≥rio.");
  const people=parsePeople(document.getElementById("editPeople").value);
  if(!people.length) return alert("Informe pelo menos 1 respons√°vel.");
  const status=document.getElementById("editStatus").value;
  const priority=document.getElementById("editPriority").value;
  const dueLocal=document.getElementById("editDue").value || null;
  const dueAt = dueLocal ? parseDTLocalToMs(dueLocal) : null;
  const dueDate = dueLocal ? dueLocal.slice(0,10) : null;
  const now=Date.now();

  const prev = taskCache[id] || {};
  const prevStatus = prev.status || "todo";

  const update={name, people, status, priority, dueDate, dueLocal, dueAt, updatedAt:now};

  // controla start/stop do tempo
  if(status==="doing"){
    if(!prev.startedAt || prevStatus==="todo") update.startedAt = prev.startedAt || now;
    update.approvedAt = null;
    update.durationMs = null;
  } else if(status==="todo"){
    update.startedAt = null;
    update.approvedAt = null;
    update.durationMs = null;
  } else if(status==="pending"){
    // mant√©m startedAt se j√° iniciou
    update.approvedAt = null;
    update.durationMs = null;
  } else if(status==="done"){
    // se marcar como done aqui, considera aprovado agora
    const startedAt = prev.startedAt || now;
    const created = prev.created || null;
    update.startedAt = startedAt;
    update.approvedAt = now;
    update.durationMs = Math.max(0, now - startedAt);
    if(created) update.leadTimeMs = Math.max(0, now - created);
  }

  db.ref("tasks/"+id).update(update);
  closeEdit();
}
function deleteTask(id){
  if(!confirm("Excluir esta tarefa?")) return;
  db.ref("tasks/"+id).remove();
}
function deleteTaskFromModal(){
  const id=document.getElementById("editId").value;
  closeEdit();
  if(id) deleteTask(id);
}

db.ref("tasks").on("value", snap=>{
  const tbody=document.getElementById("taskTable");
  tbody.innerHTML="";
  for(const k of Object.keys(taskCache)) delete taskCache[k];

  const data=snap.val()||{};
  const rows=Object.entries(data).map(([id,t])=>({id,...t}));
  rows.forEach(r=>taskCache[r.id]=r);

  const statusOrder={todo:1,doing:2,pending:3,done:4};
  const prioOrder={high:1,med:2,low:3};
  rows.sort((a,b)=>{
    const sa=statusOrder[a.status]||9, sb=statusOrder[b.status]||9;
    if(sa!==sb) return sa-sb;
    const pa=prioOrder[a.priority]||9, pb=prioOrder[b.priority]||9;
    if(pa!==pb) return pa-pb;
    return (a.created||0)-(b.created||0);
  });

  rows.forEach(t=>{
    const status=t.status||"todo";
    const prio=t.priority||"low";
    const people=(t.people||[]).join(", ");
    const pendingInfo = (status==="pending" && t.pendingBy)
      ? `<div style="color:rgba(255,255,255,.75);font-size:.78rem;margin-top:6px;">
           Marcada por: <b>${safeText(t.pendingBy)}</b>
         </div>`
      : "";

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${safeText(t.name||"")}${pendingInfo}</td>
      <td>${safeText(people)}</td>
      <td><span class="badge ${status}">${safeText(statusLabel(status))}</span></td>
      <td><span class="badge ${priorityClass(prio)}">${safeText(priorityLabel(prio))}</span></td>
      <td>${renderDueCell(t)}</td>
      <td>
        <div class="actions">
          <button class="action-btn btn-yellow" onclick="openEdit('${t.id}')">‚úèÔ∏è Editar</button>
          ${
            status==="pending"
            ? `<button class="action-btn btn-green" onclick="approve('${t.id}')">‚úÖ Aprovar</button>
               <button class="action-btn btn-red" onclick="openReopen('${t.id}')">üîÅ Reabrir</button>`
            : `<button class="action-btn btn-red" onclick="deleteTask('${t.id}')">üóëÔ∏è Excluir</button>`
          }
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
});

/* ===== DATAS ===== */
function addDate(){
  const title=document.getElementById("dateTitle").value.trim();
  const date=document.getElementById("dateValue").value;
  if(!title) return alert("Digite o t√≠tulo.");
  if(!date) return alert("Selecione a data.");
  db.ref("dates").push({title, date, created:Date.now()});
  document.getElementById("dateTitle").value="";
  document.getElementById("dateValue").value="";
}
function openEditDate(id, current){
  const newTitle=prompt("Editar t√≠tulo:", current.title||"");
  if(newTitle===null) return;
  const newDate=prompt("Editar data (YYYY-MM-DD):", current.date||"");
  if(newDate===null) return;
  const title=(newTitle||"").trim();
  const date=(newDate||"").trim();
  if(!title || !date) return alert("T√≠tulo e data s√£o obrigat√≥rios.");
  db.ref("dates/"+id).update({title, date, updatedAt:Date.now()});
}
function deleteDate(id){
  if(!confirm("Remover esta data?")) return;
  db.ref("dates/"+id).remove();
}
db.ref("dates").on("value", snap=>{
  const tbody=document.getElementById("datesTable");
  tbody.innerHTML="";
  const data=snap.val()||{};
  const rows=Object.entries(data).map(([id,d])=>({id,...d}));
  rows.sort((a,b)=>(a.date||"").localeCompare(b.date||""));
  rows.forEach(d=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${safeText(d.title||"")}</td>
      <td>${safeText(d.date||"")}</td>
      <td>
        <div class="actions">
          <button class="action-btn btn-yellow" onclick='openEditDate("${d.id}", ${JSON.stringify(d).replace(/</g,"\\u003c")})'>‚úèÔ∏è Editar</button>
          <button class="action-btn btn-red" onclick='deleteDate("${d.id}")'>üóëÔ∏è</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
});

/* ===== EQUIPE + QR ===== */
function addPerson(){
  const name=document.getElementById("personName").value.trim();
  if(!name) return alert("Digite o nome.");
  db.ref("people").push({name, created:Date.now()});
  document.getElementById("personName").value="";
}
function deletePerson(id){
  if(!confirm("Excluir este membro da equipe?")) return;
  db.ref("people/"+id).remove();
}
function toggleQr(id){
  const wrap=document.getElementById("qrwrap_"+id);
  if(!wrap) return;
  const isOpen=wrap.style.display==="flex";
  wrap.style.display=isOpen?"none":"flex";
  if(!isOpen){
    const box=document.getElementById("qrbox_"+id);
    const linkEl=document.getElementById("personlink_"+id);
    const url=linkEl.getAttribute("data-url");
    box.innerHTML="";
    new QRCode(box,{text:url,width:180,height:180,correctLevel:QRCode.CorrectLevel.M});
  }
}
async function copyLink(id){
  const linkEl=document.getElementById("personlink_"+id);
  const url=linkEl.getAttribute("data-url");
  try{await navigator.clipboard.writeText(url); alert("Link copiado!");}
  catch(e){prompt("Copie o link abaixo:", url);}
}

db.ref("people").on("value", snap=>{
  const list=document.getElementById("peopleList");
  list.innerHTML="";
  const data=snap.val()||{};
  const rows=Object.entries(data).map(([id,p])=>({id,...p}));
  rows.sort((a,b)=>(a.name||"").localeCompare(b.name||"","pt-BR",{sensitivity:"base"}));

  const base=equipeBaseUrl(); // ‚úÖ agora sempre equipe.html
  rows.forEach(p=>{
    const url=base+"?u="+encodeURIComponent(p.name||"");
    const card=document.createElement("div");
    card.className="person-card";
    card.innerHTML=`
      <div class="person-top">
        <div class="person-name">${safeText(p.name||"")}</div>
        <div class="person-actions">
          <button class="action-btn btn-yellow" onclick="toggleQr('${p.id}')">üì∑ QR</button>
          <button class="action-btn btn-muted" onclick="copyLink('${p.id}')">üîó Copiar</button>
          <button class="action-btn btn-red" onclick="deletePerson('${p.id}')">üóëÔ∏è</button>
        </div>
      </div>

      <div class="small-link" id="personlink_${p.id}" data-url="${safeText(url)}">${safeText(url)}</div>

      <div class="qr-wrap" id="qrwrap_${p.id}">
        <div class="qr-box" id="qrbox_${p.id}"></div>
        <div class="qr-note">
          Aponte a c√¢mera do celular para o QR.<br>
          Se n√£o tiver c√¢mera, a pessoa abre o link e escolhe o nome na lista.
        </div>
      </div>
    `;
    list.appendChild(card);
  });
});

/* fechar modais clicando fora */
document.getElementById("reopenModal").addEventListener("click",(e)=>{ if(e.target.id==="reopenModal") closeReopen(); });
document.getElementById("editModal").addEventListener("click",(e)=>{ if(e.target.id==="editModal") closeEdit(); });

// Login modal behaviors
requireAdminAuth();
document.getElementById("loginModal").addEventListener("click",(e)=>{ /* n√£o fecha clicando fora */ });
document.getElementById("pinInput").addEventListener("keydown",(e)=>{ if(e.key==="Enter") checkPin(); });
/* ===== RELAT√ìRIOS ===== */
function msToHuman(ms){
  const n = Number(ms||0);
  if(!n || n<0) return "0m";
  const totalHours = Math.floor(n/(1000*60*60));
  const days = Math.floor(totalHours/24);
  const hours = totalHours%24;
  const mins = Math.floor((n/(1000*60))%60);
  if(days>0) return `${days}d ${hours}h`;
  if(totalHours>0) return `${totalHours}h ${mins}m`;
  return `${mins}m`;
}
function ymdToDate(ymd){
  const m=/^(\d{4})-(\d{2})-(\d{2})$/.exec(ymd||"");
  if(!m) return null;
  return new Date(Number(m[1]), Number(m[2])-1, Number(m[3]), 0,0,0,0);
}
function refreshReport(){
  const from = document.getElementById("repFrom").value;
  const to   = document.getElementById("repTo").value;
  const split = document.getElementById("repSplit").checked;

  const fromDt = from ? ymdToDate(from) : null;
  const toDt = to ? ymdToDate(to) : null;
  if(toDt) toDt.setHours(23,59,59,999);

  const agg = {}; // name -> {count, durMs, leadMs}
  Object.values(taskCache).forEach(t=>{
    const status=t.status||"todo";
    if(status!=="done") return;

    const approvedAt = Number(t.approvedAt||0);
    if(!approvedAt) return;

    if(fromDt && approvedAt < fromDt.getTime()) return;
    if(toDt && approvedAt > toDt.getTime()) return;

    const people = Array.isArray(t.people) && t.people.length ? t.people : (t.person ? [t.person] : ["Sem Respons√°vel"]);
    const durMs = Number(t.durationMs || (t.startedAt && t.approvedAt ? (t.approvedAt - t.startedAt) : 0) || 0);
    const leadMs = Number((t.created && t.approvedAt) ? (t.approvedAt - t.created) : 0);

    const share = split && people.length ? (durMs/people.length) : durMs;
    const shareLead = split && people.length ? (leadMs/people.length) : leadMs;

    people.forEach(p=>{
      const key = String(p||"Sem Respons√°vel");
      if(!agg[key]) agg[key] = {count:0, durMs:0, leadMs:0};
      agg[key].count += 1;
      agg[key].durMs += share;
      agg[key].leadMs += shareLead;
    });
  });

  const rows = Object.entries(agg).sort((a,b)=>b[1].durMs - a[1].durMs);
  const tbody = document.getElementById("reportTable");
  tbody.innerHTML = "";

  if(!rows.length){
    const tr=document.createElement("tr");
    tr.innerHTML = `<td colspan="5" style="color:rgba(255,255,255,.75);text-align:center;padding:16px;">Sem tarefas aprovadas no per√≠odo.</td>`;
    tbody.appendChild(tr);
    return;
  }

  rows.forEach(([name,v])=>{
    const avg = v.count ? (v.durMs / v.count) : 0;
    const avgLead = v.count ? (v.leadMs / v.count) : 0;
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td><b style="color:#fff;">${safeText(name)}</b></td>
      <td>${v.count}</td>
      <td>${msToHuman(v.durMs)}</td>
      <td>${msToHuman(avg)}</td>
      <td>${msToHuman(v.leadMs)} <span style="opacity:.7"> (m√©dia ${msToHuman(avgLead)})</span></td>
    `;
    tbody.appendChild(tr);
  });
}
function exportReportCSV(){
  // gera CSV a partir do relat√≥rio atual (tabela)
  const rows = [];
  rows.push(["Pessoa","Tarefas","Tempo_execucao","Tempo_medio","Lead_time"]);
  const tbody = document.getElementById("reportTable");
  const trs = Array.from(tbody.querySelectorAll("tr"));
  trs.forEach(tr=>{
    const tds = Array.from(tr.querySelectorAll("td")).map(td=>td.innerText.replace(/\s+/g," ").trim());
    if(tds.length===5) rows.push(tds);
  });
  const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "relatorio_tmg.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
// atualiza autom√°tico quando tasks mudam e quando filtros mudam
["repFrom","repTo","repSplit"].forEach(id=>{
  const el=document.getElementById(id);
  if(el) el.addEventListener("change", refreshReport);
});
setTimeout(()=>{ try{ refreshReport(); }catch(e){} }, 800);

</script>
</body>
</html>

function pad2(n){return String(n).padStart(2,"0");}
function parseDTLocalToMs(v){
  // v = "YYYY-MM-DDTHH:MM"
  if(!v) return null;
  const m = /^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})$/.exec(v);
  if(!m) return null;
  const y=Number(m[1]), mo=Number(m[2])-1, d=Number(m[3]), hh=Number(m[4]), mm=Number(m[5]);
  return new Date(y, mo, d, hh, mm, 0, 0).getTime();
}
function msToDTLocal(ms){
  if(ms==null) return "";
  const d=new Date(Number(ms));
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}
function formatBRDateTime(msOrLocalOrDate){
  // accepts: ms (number), "YYYY-MM-DDTHH:MM", or "YYYY-MM-DD"
  let d=null;
  if(typeof msOrLocalOrDate==="number") d=new Date(msOrLocalOrDate);
  else if(typeof msOrLocalOrDate==="string" && msOrLocalOrDate.includes("T")) d=new Date(parseDTLocalToMs(msOrLocalOrDate));
  else if(typeof msOrLocalOrDate==="string") d=parseYMD(msOrLocalOrDate);
  if(!d || isNaN(d.getTime())) return "‚Äî";
  return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}

