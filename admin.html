<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - Cronograma Oficina</title>

  <style>
    :root{
      --bg1:#0b0c10;
      --bg2:#050607;
      --cyan:#00e6ff;
      --cyan2:#00a7bb;
      --green:#35ff4a;
      --orange:#ff5a00;
      --red:#ff2d2d;
      --card:#0b0f12cc;
      --stroke:#00a7bb66;
      --stroke2:#00e6ff22;
      --text:#e7f6ff;
      --muted:#9fb6c3;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 60% 20%, #0b2a33 0%, transparent 60%),
        radial-gradient(900px 600px at 20% 80%, #14310f 0%, transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }
    header{
      height:74px;
      display:flex;
      align-items:center;
      padding:0 22px;
      background:linear-gradient(180deg, #d9d9d9, #bdbdbd);
      color:#111;
      border-bottom:1px solid #00000022;
      position:sticky; top:0; z-index:10;
    }
    header .brand{
      display:flex; align-items:center; gap:14px;
      font-weight:900; letter-spacing:.06em;
      text-transform:uppercase;
    }
    header .brand img{
      height:38px;
      width:auto;
      object-fit:contain;
      filter: drop-shadow(0 2px 2px rgba(0,0,0,.25));
    }
    header .right{
      margin-left:auto;
      font-weight:800;
      letter-spacing:.08em;
      text-transform:uppercase;
      opacity:.9;
    }

    .wrap{max-width:1200px; margin:26px auto; padding:0 14px;}
    .panel{
      background:var(--card);
      border:2px solid var(--stroke);
      box-shadow: 0 0 18px rgba(0,231,255,.25);
      border-radius:18px;
      padding:18px;
      overflow:hidden;
    }
    .tabs{
      display:flex; gap:10px; justify-content:center;
      margin:10px 0 18px;
      flex-wrap:wrap;
    }
    .tab{
      border:1px solid #ffffff22;
      background:#0d1114;
      color:#fff;
      padding:10px 16px;
      border-radius:999px;
      cursor:pointer;
      font-weight:800;
      letter-spacing:.05em;
      text-transform:uppercase;
      transition:.15s;
      user-select:none;
    }
    .tab.active{
      background:linear-gradient(180deg, #1aff48, #0a7b1d);
      color:#031006;
      border-color:#0f5f1f;
      box-shadow:0 0 18px rgba(53,255,74,.25);
    }
    .content{display:none}
    .content.active{display:block}

    h2{
      margin:0 0 12px;
      text-align:center;
      color:var(--orange);
      font-size:36px;
      letter-spacing:.06em;
      text-transform:uppercase;
      text-shadow:0 0 14px rgba(255,90,0,.15);
    }

    .formrow{
      display:grid;
      grid-template-columns: 1.2fr 1fr .7fr auto;
      gap:12px;
      align-items:end;
      margin-bottom:12px;
    }
    .formrow.tasks{
      grid-template-columns: 1.2fr 1fr .8fr .7fr .8fr auto;
    }

    label{
      display:block;
      font-weight:800;
      color:var(--cyan);
      margin:0 0 6px;
      letter-spacing:.04em;
      text-transform:uppercase;
      font-size:12px;
    }
    input, select, textarea{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid #ffffff22;
      background:#0b0f12;
      color:var(--text);
      outline:none;
      box-shadow: inset 0 0 0 1px #00000044;
    }
    textarea{min-height:68px; resize:vertical}

    .btn{
      padding:12px 18px;
      border-radius:14px;
      border:0;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.05em;
      text-transform:uppercase;
      background:linear-gradient(180deg, #1aff48, #0a7b1d);
      color:#031006;
      box-shadow:0 0 16px rgba(53,255,74,.25);
      transition:.15s;
      white-space:nowrap;
    }
    .btn:hover{filter:brightness(1.03)}
    .btn.danger{
      background:linear-gradient(180deg, #ff4a4a, #b01212);
      color:#170202;
      box-shadow:0 0 16px rgba(255,45,45,.18);
    }
    .btn.ghost{
      background:#101417;
      color:#fff;
      border:1px solid #ffffff22;
      box-shadow:none;
    }
    .btn.mini{
      padding:8px 12px;
      border-radius:12px;
      font-size:12px;
      text-transform:none;
      letter-spacing:0;
      font-weight:800;
      background:#e9eef2;
      color:#111;
      box-shadow:none;
    }
    .btn.mini.danger{ background:#ff3c3c; color:#120202; }

    .table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
    }
    .table th, .table td{
      padding:12px 10px;
      border-bottom:1px solid #ffffff1a;
      text-align:left;
      vertical-align:middle;
    }
    .table th{
      color:var(--cyan);
      font-weight:900;
      letter-spacing:.05em;
      text-transform:uppercase;
      font-size:12px;
    }
    .muted{color:var(--muted)}
    .pill{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      letter-spacing:.04em;
      text-transform:uppercase;
      font-size:11px;
      border:1px solid #ffffff22;
    }
    .pill.ok{background:#0e2b15; color:#74ff8a; border-color:#2fff6d33}
    .pill.warn{background:#2b220e; color:#ffd37a; border-color:#ffcc6633}
    .pill.info{background:#0e1e2b; color:#88d8ff; border-color:#66ccff33}

    .actions{display:flex; gap:8px; flex-wrap:wrap}

    /* Modal QR */
    .modal{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.7);
      z-index:50;
      padding:14px;
    }
    .modal.open{display:flex}
    .modalbox{
      width:min(860px, 96vw);
      background:rgba(10,13,15,.95);
      border:2px solid var(--stroke);
      box-shadow:0 0 22px rgba(0,231,255,.28);
      border-radius:18px;
      padding:16px;
      position:relative;
    }
    .modalgrid{
      display:grid;
      grid-template-columns: 300px 1fr;
      gap:16px;
      align-items:start;
    }
    .qrbox{
      border-radius:16px;
      border:1px solid #ffffff22;
      background:#0b0f12;
      padding:14px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .qrbox img{width:260px; height:260px}
    .modaltitle{
      margin:0 0 10px;
      color:var(--orange);
      font-size:22px;
      font-weight:1000;
      letter-spacing:.05em;
      text-transform:uppercase;
    }
    .modalclose{
      position:absolute;
      right:14px; top:14px;
      background:#111;
      color:#fff;
      border:1px solid #ffffff22;
      padding:10px 14px;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
    }
    .toast{
      position:fixed;
      left:50%; transform:translateX(-50%);
      bottom:18px;
      background:#0b0f12;
      border:1px solid #ffffff22;
      box-shadow:0 0 18px rgba(0,231,255,.20);
      color:#fff;
      padding:10px 14px;
      border-radius:14px;
      display:none;
      z-index:60;
      font-weight:800;
    }
    .toast.show{display:block}
    @media (max-width: 780px){
      .formrow{grid-template-columns: 1fr; }
      .formrow.tasks{grid-template-columns: 1fr;}
      .modalgrid{grid-template-columns: 1fr;}
      .qrbox img{width:240px;height:240px}
    }
  </style>
</head>
<body>
<header>
  <div class="brand">
    <img src="tmg_logo.png" alt="TMG racing">
  </div>
  <div class="right">Admin</div>
</header>

<div class="wrap">
  <div class="panel">
    <div class="tabs">
      <div class="tab active" data-tab="members">Membros</div>
      <div class="tab" data-tab="tasks">Tarefas</div>
      <div class="tab" data-tab="dates">Datas importantes</div>
      <div class="tab" data-tab="reset">Zerar tudo</div>
    </div>

    <!-- MEMBROS -->
    <div class="content active" id="tab-members">
      <h2>Membros</h2>

      <div class="formrow">
        <div>
          <label>Nome</label>
          <input id="mName" placeholder="Ex: RENÊ" />
        </div>
        <div>
          <label>Função (opcional)</label>
          <input id="mRole" placeholder="Ex: Montagem" />
        </div>
        <div>
          <label>Ativo?</label>
          <select id="mActive">
            <option>Sim</option>
            <option>Nao</option>
          </select>
        </div>
        <button class="btn" onclick="addMember()">Adicionar</button>
      </div>

      <div class="muted" style="margin:6px 0 12px;">
        Cada membro tem um QR Code individual que abre direto: <span class="pill info">/equipe?m=Nome</span>
      </div>

      <table class="table">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Função</th>
            <th>Ativo</th>
            <th style="width:360px;">Ações</th>
          </tr>
        </thead>
        <tbody id="tbMembers"></tbody>
      </table>
    </div>

    <!-- TAREFAS -->
    <div class="content" id="tab-tasks">
      <h2>Tarefas</h2>

      <div class="formrow tasks">
        <div>
          <label>Título</label>
          <input id="tTitle" placeholder="Ex: Montar asa" />
        </div>
        <div>
          <label>Responsável</label>
          <select id="tMember">
            <option value="">Selecione</option>
          </select>
        </div>
        <div>
          <label>Prazo (data)</label>
          <input id="tDate" type="date" />
        </div>
        <div>
          <label>Prazo (hora)</label>
          <input id="tTime" type="time" />
        </div>
        <div>
          <label>Prioridade</label>
          <select id="tPriority">
            <option>Baixa</option>
            <option>Média</option>
            <option>Alta</option>
          </select>
        </div>
        <button class="btn" onclick="addTask()">Adicionar</button>
      </div>

      <div style="margin:10px 0;">
        <label>Descrição (opcional)</label>
        <textarea id="tDesc" placeholder="Detalhes da tarefa..."></textarea>
      </div>

      <table class="table">
        <thead>
          <tr>
            <th>Tarefa</th>
            <th>Responsável</th>
            <th>Prazo</th>
            <th>Prioridade</th>
            <th>Status</th>
            <th style="width:260px;">Ações</th>
          </tr>
        </thead>
        <tbody id="tbTasks"></tbody>
      </table>
    </div>

    <!-- DATAS IMPORTANTES -->
    <div class="content" id="tab-dates">
      <h2>Datas importantes</h2>

      <div class="formrow" style="grid-template-columns: 1.2fr .8fr auto;">
        <div>
          <label>Evento</label>
          <input id="dTitle" placeholder="Ex: Corrida / Teste / Entrega" />
        </div>
        <div>
          <label>Data</label>
          <input id="dDate" type="date" />
        </div>
        <button class="btn" onclick="addDate()">Adicionar</button>
      </div>

      <table class="table">
        <thead>
          <tr>
            <th>Evento</th>
            <th>Data</th>
            <th style="width:140px;">Ações</th>
          </tr>
        </thead>
        <tbody id="tbDates"></tbody>
      </table>
    </div>

    <!-- RESET -->
    <div class="content" id="tab-reset">
      <h2>Zerar tudo</h2>
      <p class="muted" style="text-align:center; max-width:760px; margin:12px auto;">
        Isso apaga <b>membros</b>, <b>tarefas</b> e <b>datas importantes</b> do Firebase.
        Compras/requisições são zeradas no Admin Compras (arquivo próprio).
      </p>
      <div style="display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin-top:14px;">
        <button class="btn danger" onclick="resetAll()">Apagar tudo agora</button>
        <button class="btn ghost" onclick="seedExample()">Criar exemplo</button>
      </div>
    </div>

  </div>
</div>

<!-- MODAL QR -->
<div class="modal" id="qrModal" onclick="if(event.target.id==='qrModal') closeQR()">
  <div class="modalbox">
    <button class="modalclose" onclick="closeQR()">Fechar</button>
    <div class="modalgrid">
      <div class="qrbox">
        <img id="qrImg" alt="QR Code" />
      </div>
      <div>
        <div class="modaltitle" id="qrTitle">QR Code</div>
        <label>Link do membro</label>
        <input id="qrLink" readonly />
        <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
          <button class="btn" style="padding:10px 14px" onclick="(function(){navigator.clipboard.writeText(document.getElementById('qrLink').value); toast('Link copiado!');})();">Copiar link</button>
          <button class="btn ghost" style="padding:10px 14px" onclick="window.open(document.getElementById('qrLink').value,'_blank')">Abrir link</button>
        </div>
        <div class="muted" style="margin-top:10px;">
          Dica: esse QR abre direto a tela da equipe já no membro.
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
  // ========= Firebase config =========
  // (mantido igual ao seu arquivo)
  const firebaseConfig = {
    apiKey: "YOUR_KEY",
    authDomain: "YOUR_DOMAIN",
    databaseURL: "YOUR_DB_URL",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_BUCKET",
    messagingSenderId: "YOUR_SENDER",
    appId: "YOUR_APP_ID"
  };

  // inicializa (evita duplicar)
  if(!firebase.apps.length){ firebase.initializeApp(firebaseConfig); }
  const db = firebase.database();

  // ========= Helpers =========
  function escapeHtml(str){
    return (str||"").replace(/[&<>'"]/g, s => ({
      '&':'&amp;','<':'&lt;','>':'&gt;',"'" :'&#39;','"':'&quot;'
    }[s]));
  }
  function toast(msg){
    const el = document.getElementById('toast');
    if(!el) return;
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(()=>el.classList.remove('show'), 1400);
  }

  // ========= State caches =========
  let membersCache = [];
  let tasksCache = [];
  let datesCache = [];

  // ========= Realtime listeners =========
  db.ref("people").on("value", snap=>{
    const val = snap.val() || {};
    membersCache = Object.values(val);
    renderMembers();
    refreshMemberSelect();
  });

  db.ref("tasks").on("value", snap=>{
    const val = snap.val() || {};
    tasksCache = Object.values(val);
    renderTasks();
  });

  db.ref("importantDates").on("value", snap=>{
    const val = snap.val() || {};
    datesCache = Object.values(val);
    renderDates();
  });

function normalizeName(s){ return (s||"").trim().toLowerCase(); }

function renderMembers(){
  const tb = document.getElementById('tbMembers');
  if(!tb) return;
  tb.innerHTML = '';

  if(!membersCache || membersCache.length===0){
    tb.innerHTML = `<tr><td colspan="4" class="muted">Nenhum membro cadastrado.</td></tr>`;
    return;
  }

  // ordena por nome e garante render único (evita duplicar na tela)
  const seen = new Set();
  const list = membersCache
    .slice()
    .sort((a,b)=> (a.name||"").localeCompare(b.name||"", 'pt-BR', {sensitivity:'base'}))
    .filter(m=>{
      const k = normalizeName(m.name);
      if(!k) return false;
      if(seen.has(k)) return false;
      seen.add(k);
      return true;
    });

  list.forEach(m=>{
    const name = m.name || '-';
    const role = m.role || '-';
    const active = (m.active!==false); // default true
    tb.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${escapeHtml(name)}</td>
        <td>${escapeHtml(role)}</td>
        <td>${active ? '<span class="pill ok">Ativo</span>' : '<span class="pill warn">Inativo</span>'}</td>
        <td class="actions">
          <button class="btn mini" onclick="openQR('${m.id}')">QR</button>
          <button class="btn mini" onclick="copyMemberLink('${m.id}')">Copiar link</button>
          ${active
            ? `<button class="btn mini" onclick="toggleMemberActive('${m.id}', false)">Desativar</button>`
            : `<button class="btn mini" onclick="toggleMemberActive('${m.id}', true)">Ativar</button>`
          }
          <button class="btn mini danger" onclick="deleteMember('${m.id}')">Apagar</button>
        </td>
      </tr>
    `);
  });
}

function addMember(){
  const name = (document.getElementById("mName")?.value || "").trim();
  const role = (document.getElementById("mRole")?.value || "").trim();
  const activeSel = document.getElementById("mActive");
  const active = activeSel ? (activeSel.value !== "Nao") : true;

  if(!name){ alert("Digite o nome do membro."); return; }

  // bloqueia duplicados por nome (case-insensitive)
  const key = normalizeName(name);
  const exists = (membersCache||[]).some(m => normalizeName(m.name) === key);
  if(exists){
    alert("Esse membro já existe. Se precisar, desative/ative ou apague e cadastre novamente.");
    return;
  }

  const id = "m_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,6);
  db.ref("people/"+id).set({ id, name, role, active, createdAt: Date.now() });

  // limpa inputs
  if(document.getElementById("mName")) document.getElementById("mName").value="";
  if(document.getElementById("mRole")) document.getElementById("mRole").value="";
  if(activeSel) activeSel.value = "Sim";
}

function toggleMember(id, active){
  db.ref("people/"+id).update({ active });
}
function toggleMemberActive(id, active){ // alias para o onclick
  toggleMember(id, active);
}

function delMember(id){
  if(!confirm("Apagar este membro? Isso não apaga tarefas/requisições já criadas.")) return;
  db.ref("people/"+id).remove();
}
function deleteMember(id){ // alias para o onclick
  delMember(id);
}

function getMemberLinkByName(name){
  const base = (location.origin + location.pathname).replace(/\/admin.*$/,'/equipe');
  const q = encodeURIComponent(name || "");
  return `${base}?m=${q}`;
}

function openQR(id){
  const modal = document.getElementById("qrModal");
  const title = document.getElementById("qrTitle");
  const img = document.getElementById("qrImg");
  const linkEl = document.getElementById("qrLink");

  const m = (membersCache||[]).find(x => x.id === id);
  const name = m?.name || "";

  if(!name){ alert("Membro não encontrado."); return; }

  const link = getMemberLinkByName(name);

  if(title) title.textContent = "QR Code - " + name.toUpperCase();
  if(linkEl) linkEl.value = link;

  // gera QR via API simples
  if(img){
    const qrUrl = "https://api.qrserver.com/v1/create-qr-code/?size=260x260&data=" + encodeURIComponent(link);
    img.src = qrUrl;
    img.alt = "QR do membro " + name;
  }

  if(modal) modal.classList.add("open");
}

function copyMemberLink(id){
  const m = (membersCache||[]).find(x => x.id === id);
  const name = m?.name || "";
  if(!name){ alert("Membro não encontrado."); return; }
  const link = getMemberLinkByName(name);

  navigator.clipboard.writeText(link).then(()=>{
    toast("Link copiado!");
  }).catch(()=>{
    // fallback
    const ta = document.createElement("textarea");
    ta.value = link;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
    toast("Link copiado!");
  });
}

function closeQR(){
  const modal = document.getElementById("qrModal");
  if(modal) modal.classList.remove("open");
}

  // ========= Tasks =========
  function refreshMemberSelect(){
    const sel = document.getElementById("tMember");
    if(!sel) return;
    const current = sel.value;
    sel.innerHTML = `<option value="">Selecione</option>`;
    (membersCache||[])
      .filter(m => m.active !== false)
      .sort((a,b)=> (a.name||"").localeCompare(b.name||"", 'pt-BR', {sensitivity:'base'}))
      .forEach(m=>{
        const opt = document.createElement("option");
        opt.value = m.name;
        opt.textContent = m.name;
        sel.appendChild(opt);
      });
    if(current) sel.value = current;
  }

  function addTask(){
    const title = (document.getElementById("tTitle")?.value || "").trim();
    const member = (document.getElementById("tMember")?.value || "").trim();
    const date = document.getElementById("tDate")?.value || "";
    const time = document.getElementById("tTime")?.value || "";
    const desc = (document.getElementById("tDesc")?.value || "").trim();
    const priority = document.getElementById("tPriority")?.value || "Baixa";

    if(!title){ alert("Digite o título."); return; }
    if(!member){ alert("Selecione o responsável."); return; }
    if(!date){ alert("Selecione a data."); return; }

    const id = "t_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,6);
    const dueAt = new Date(date + "T" + (time || "00:00")).getTime();

    db.ref("tasks/"+id).set({
      id,
      title,
      member,
      date,
      time,
      dueAt,
      desc,
      priority,
      status: "a_fazer",
      createdAt: Date.now()
    });

    document.getElementById("tTitle").value="";
    document.getElementById("tMember").value="";
    document.getElementById("tDate").value="";
    document.getElementById("tTime").value="";
    document.getElementById("tDesc").value="";
    document.getElementById("tPriority").value="Baixa";
  }

  function fmtDateTime(t){
    if(!t) return "-";
    try{
      const d = new Date(t);
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yyyy = d.getFullYear();
      const hh = String(d.getHours()).padStart(2,'0');
      const mi = String(d.getMinutes()).padStart(2,'0');
      return `${dd}/${mm}/${yyyy}, ${hh}:${mi}`;
    }catch(e){ return "-"; }
  }

  function renderTasks(){
    const tb = document.getElementById("tbTasks");
    if(!tb) return;
    tb.innerHTML = "";
    const list = (tasksCache||[]).slice().sort((a,b)=>(a.dueAt||0)-(b.dueAt||0));
    if(list.length===0){
      tb.innerHTML = `<tr><td colspan="6" class="muted">Nenhuma tarefa cadastrada.</td></tr>`;
      return;
    }
    list.forEach(t=>{
      const pr = (t.priority||"Baixa");
      const statusLabel = (t.status||"a_fazer").replaceAll("_"," ");
      const prPill = pr==="Alta" ? "warn" : (pr==="Média" ? "info" : "ok");

      tb.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${escapeHtml(t.title||"-")}</td>
          <td>${escapeHtml(t.member||"-")}</td>
          <td>${fmtDateTime(t.dueAt)}</td>
          <td><span class="pill ${prPill}">${escapeHtml(pr)}</span></td>
          <td><span class="pill info">${escapeHtml(statusLabel)}</span></td>
          <td class="actions">
            <button class="btn mini" onclick="setTaskStatus('${t.id}','a_fazer')">A fazer</button>
            <button class="btn mini" onclick="setTaskStatus('${t.id}','em_andamento')">Em andamento</button>
            <button class="btn mini" onclick="setTaskStatus('${t.id}','concluida')">Concluída</button>
            <button class="btn mini" onclick="editTask('${t.id}')">Editar</button>
            <button class="btn mini danger" onclick="deleteTask('${t.id}')">Apagar</button>
          </td>
        </tr>
      `);
    });
  }

  function setTaskStatus(id, status){
    db.ref("tasks/"+id).update({ status });
  }
  function deleteTask(id){
    if(!confirm("Apagar esta tarefa?")) return;
    db.ref("tasks/"+id).remove();
  }

  function editTask(id){
    const t = (tasksCache||[]).find(x=>x.id===id);
    if(!t){ alert("Tarefa não encontrada"); return; }

    const newDate = prompt("Nova data (YYYY-MM-DD):", t.date || "");
    if(newDate===null) return;

    const newTime = prompt("Nova hora (HH:MM) opcional:", t.time || "");
    if(newTime===null) return;

    const newPr = prompt("Prioridade (Baixa/Média/Alta):", t.priority || "Baixa");
    if(newPr===null) return;

    const dueAt = new Date(newDate + "T" + (newTime || "00:00")).getTime();

    db.ref("tasks/"+id).update({
      date: newDate,
      time: newTime,
      priority: newPr,
      dueAt
    });
    toast("Tarefa atualizada!");
  }

  // ========= Dates =========
  function addDate(){
    const title = (document.getElementById("dTitle")?.value || "").trim();
    const date = document.getElementById("dDate")?.value || "";
    if(!title){ alert("Digite o evento."); return; }
    if(!date){ alert("Selecione a data."); return; }

    const id = "d_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,6);
    db.ref("importantDates/"+id).set({ id, title, date, createdAt: Date.now() });

    document.getElementById("dTitle").value="";
    document.getElementById("dDate").value="";
  }

  function renderDates(){
    const tb = document.getElementById("tbDates");
    if(!tb) return;
    tb.innerHTML = "";
    const list = (datesCache||[]).slice().sort((a,b)=>(a.date||"").localeCompare(b.date||""));
    if(list.length===0){
      tb.innerHTML = `<tr><td colspan="3" class="muted">Nenhuma data cadastrada.</td></tr>`;
      return;
    }
    list.forEach(d=>{
      tb.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${escapeHtml(d.title||"-")}</td>
          <td>${escapeHtml(d.date||"-")}</td>
          <td class="actions">
            <button class="btn mini danger" onclick="deleteDate('${d.id}')">Apagar</button>
          </td>
        </tr>
      `);
    });
  }
  function deleteDate(id){
    if(!confirm("Apagar esta data?")) return;
    db.ref("importantDates/"+id).remove();
  }

  // ========= Reset =========
  function resetAll(){
    if(!confirm("Tem certeza? Isso apaga membros, tarefas e datas importantes.")) return;
    Promise.all([
      db.ref("people").remove(),
      db.ref("tasks").remove(),
      db.ref("importantDates").remove()
    ]).then(()=>toast("Tudo apagado!"));
  }

  function seedExample(){
    const m1 = "m_" + Date.now().toString(36) + "_a";
    db.ref("people/"+m1).set({id:m1,name:"DAVI",role:"Montagem",active:true,createdAt:Date.now()});

    const t1 = "t_" + Date.now().toString(36) + "_a";
    const date = new Date(); date.setDate(date.getDate()+2);
    const y = date.getFullYear();
    const m = String(date.getMonth()+1).padStart(2,'0');
    const d = String(date.getDate()).padStart(2,'0');
    const dateStr = `${y}-${m}-${d}`;
    const dueAt = new Date(dateStr+"T10:00").getTime();

    db.ref("tasks/"+t1).set({
      id:t1,title:"Cotação peças",member:"DAVI",date:dateStr,time:"10:00",
      dueAt,desc:"",priority:"Média",status:"a_fazer",createdAt:Date.now()
    });

    const dd = "d_" + Date.now().toString(36) + "_a";
    db.ref("importantDates/"+dd).set({id:dd,title:"Teste pista",date:dateStr,createdAt:Date.now()});

    toast("Exemplo criado!");
  }

  // ========= Tabs =========
  document.querySelectorAll(".tab").forEach(t=>{
    t.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      const key = t.getAttribute("data-tab");
      document.querySelectorAll(".content").forEach(c=>c.classList.remove("active"));
      document.getElementById("tab-"+key).classList.add("active");
    });
  });
</script>

</body>
</html>
