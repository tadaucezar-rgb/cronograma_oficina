<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Admin - Compras</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{margin:0;font-family:'Orbitron',Arial,sans-serif;background:radial-gradient(circle at top,#0a0a0a,#000);color:#00e5ff;}
header{padding:14px;background:linear-gradient(90deg,#bdbdbd,#e0e0e0,#bdbdbd);color:#000;font-weight:900;text-align:center;}
.container{padding:14px;max-width:980px;margin:auto;}
.card{background:rgba(0,0,0,.78);border-radius:18px;padding:16px;border:2px solid rgba(0,229,255,.22);box-shadow:0 0 26px rgba(0,229,255,.22);margin-bottom:12px;}
h2{margin-top:0;color:#ff3d00;text-align:center;}
table{width:100%;border-collapse:collapse;font-size:.85rem;}
th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.15);text-align:left;vertical-align:top;}
button{padding:8px 12px;border-radius:12px;border:none;font-family:'Orbitron',Arial,sans-serif;font-weight:900;cursor:pointer;}
.btn-ok{background:linear-gradient(90deg,#00c853,#64dd17);color:#000;}
.btn-no{background:linear-gradient(90deg,#b71c1c,#ff1744);color:#fff;}
input{padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.08);color:#fff;font-family:'Orbitron';width:100%;margin-top:8px;}
.pin{max-width:320px;margin:60px auto;}
.small{font-size:.75rem;opacity:.8;}
.note{font-size:.78rem;opacity:.85;text-align:center;margin-top:10px;color:rgba(255,255,255,.75);}
</style>
</head>

<body>

<header>Administração de Compras</header>

<div class="container" id="login">
  <div class="card pin">
    <h2>PIN de acesso</h2>
    <input id="pin" type="password" placeholder="Digite o PIN">
    <button class="btn-ok" style="margin-top:12px;width:100%;" onclick="checkPin()">Entrar</button>
    <div class="note">PIN simples apenas para evitar alterações por engano.</div>
  </div>
</div>

<div class="container" id="content" style="display:none;">
  <div class="card">
    <h2>Requisições Pendentes</h2>
    <table>
      <thead>
        <tr>
          <th>Data</th>
          <th>Membro</th>
          <th>Centro de custo</th>
          <th>Item</th>
          <th>Qtd</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
    <div class="note">Mostra apenas solicitações com status <b>requested</b>. (Compatível com registros antigos)</div>
  </div>
</div>

<script>
const ADMIN_PIN="1234"; // <<< ALTERE AQUI

const firebaseConfig={
  apiKey:"AIzaSyBPz4aSee-kQY5hwlyzEw_4Jv3gGKL9iHY",
  authDomain:"tmg-painel.firebaseapp.com",
  databaseURL:"https://tmg-painel-default-rtdb.firebaseio.com",
  projectId:"tmg-painel",
  storageBucket:"tmg-painel.firebasestorage.app",
  messagingSenderId:"877912378151",
  appId:"1:877912378151:web:88af3a4f8f551acd603702"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

function checkPin(){
  if(document.getElementById("pin").value===ADMIN_PIN){
    document.getElementById("login").style.display="none";
    document.getElementById("content").style.display="block";
    load();
  }else alert("PIN incorreto");
}

function fmt(ts){
  if(!ts) return "-";
  return new Date(ts).toLocaleString("pt-BR");
}

// Compatibilidade: aceita campos antigos e novos
function getMember(r){
  return r.member || r.requestedBy || r.solicitadoPor || r.solicitante || "-";
}
function getCost(r){
  return r.cost || r.centroCusto || r.costCenter || r.cc || "-";
}
function getItem(r){
  return r.item || r.description || r.descricao || "-";
}
function getQty(r){
  const q = (typeof r.qty === "number" && isFinite(r.qty)) ? r.qty : (isFinite(Number(r.qty)) ? Number(r.qty) : 0);
  const u = r.unit || r.un || r.unidade || "";
  return `${q} ${u}`.trim();
}
function getRequestedAt(r){
  return r.requestedAt || r.createdAt || r.created || r.ts || null;
}

function load(){
  db.ref("purchaseRequests").on("value",snap=>{
    const data=snap.val()||{};
    const tbody=document.getElementById("rows");
    tbody.innerHTML="";

    Object.entries(data).forEach(([id,r])=>{
      if((r.status||"")!=="requested") return;

      const member = getMember(r);
      const cost = getCost(r);
      const item = getItem(r);
      const qtd = getQty(r);
      const reqAt = getRequestedAt(r);

      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${fmt(reqAt)}</td>
        <td>${member}</td>
        <td>${cost}</td>
        <td>${item}${r.obs?`<div class="small">${escapeHtml(String(r.obs))}</div>`:""}</td>
        <td>${qtd}</td>
        <td>
          <button class="btn-ok" onclick="approve('${id}')">Autorizar</button>
          <button class="btn-no" onclick="reject('${id}')">Recusar</button>
        </td>`;
      tbody.appendChild(tr);
    });

    if(!tbody.children.length){
      const tr=document.createElement("tr");
      tr.innerHTML = `<td colspan="6" class="small">Nenhuma requisição pendente.</td>`;
      tbody.appendChild(tr);
    }
  });
}

function approve(id){
  db.ref("purchaseRequests/"+id).update({
    status:"authorized",
    authorizedAt:Date.now()
  });
}
function reject(id){
  const reason = prompt("Motivo da recusa (opcional):","");
  if(reason===null) return; // cancel
  db.ref("purchaseRequests/"+id).update({
    status:"rejected",
    rejectedAt:Date.now(),
    rejectedReason: (reason||"").trim()
  });
}

function escapeHtml(s){
  return s.replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}
</script>
</body>
</html>
