<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin Compras</title>
<style>
body{margin:0;font-family:'Orbitron',Arial,sans-serif;background:radial-gradient(circle at top,#0a0a0a,#000);color:#00e5ff;}
header{padding:14px;background:linear-gradient(90deg,#bdbdbd,#e0e0e0,#bdbdbd);color:#000;font-weight:900;text-align:center;}
.container{padding:14px;max-width:900px;margin:auto;}
.card{background:rgba(0,0,0,.78);border-radius:18px;padding:16px;border:2px solid rgba(0,229,255,.22);box-shadow:0 0 26px rgba(0,229,255,.22);margin-bottom:12px;}
h2{margin-top:0;color:#ff3d00;text-align:center;}
table{width:100%;border-collapse:collapse;font-size:.85rem;}
th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.15);text-align:left;}
button{padding:8px 12px;border-radius:12px;border:none;font-family:'Orbitron',Arial,sans-serif;font-weight:900;cursor:pointer;}
.btn-ok{background:linear-gradient(90deg,#00c853,#64dd17);color:#000;}
.btn-no{background:linear-gradient(90deg,#b71c1c,#ff1744);color:#fff;}
input{padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.08);color:#fff;font-family:'Orbitron';}
.pin{max-width:300px;margin:60px auto;}

.tabbar{display:flex;gap:10px;justify-content:center;margin:12px 0 18px 0;flex-wrap:wrap}
.tabbtn{padding:10px 16px;border-radius:18px;border:1px solid rgba(0,229,255,.25);background:#111;color:#eaeaea;cursor:pointer;font-weight:800}
.tabbtn.active{background:#2bdc0f;color:#031300;border-color:transparent;box-shadow:0 0 18px rgba(43,220,15,.35)}
.small{font-size:12px;opacity:.85}
.pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:900;letter-spacing:.6px}
.pill.requested{background:rgba(0,229,255,.12);border:1px solid rgba(0,229,255,.35);color:#00e5ff}
.pill.authorized{background:rgba(43,220,15,.15);border:1px solid rgba(43,220,15,.45);color:#2bdc0f}
.pill.purchased{background:rgba(0,120,255,.15);border:1px solid rgba(0,120,255,.45);color:#44a7ff}
.pill.received{background:rgba(255,165,0,.15);border:1px solid rgba(255,165,0,.45);color:#ffb347}
.pill.rejected{background:rgba(255,0,0,.15);border:1px solid rgba(255,0,0,.45);color:#ff5252}
tr.overdue td{background:rgba(255,0,0,.06)}
</style>
</head>
<body>
<header>Admin Compras</header>

<div class="container">
  <div class="card" id="pinCard">
    <h2 style="margin-top:0;color:#ff6a00;">PIN</h2>
    <div class="row">
      <input id="pinInput" class="input" placeholder="Digite o PIN"/>
      <button class="btn" id="btnPin">Entrar</button>
    </div>
    <div class="small" style="margin-top:8px">Dica: para testar, o PIN está em <b>PIN_ADMIN_COMPRAS</b> no código.</div>
  </div>

  <div class="card hidden" id="appCard">
    <div class="tabbar">
      <button class="tabbtn active" data-tab="auth">Autorizações</button>
      <button class="tabbtn" data-tab="track">Acompanhamento</button>
      <button class="tabbtn" id="btnZerar">Zerar histórico</button>
    </div>

    <div id="tab-auth">
      <h2 style="margin-top:0;color:#ff6a00;">Requisições pendentes</h2>
      <table>
        <thead>
          <tr>
            <th>Data</th>
            <th>Solicitante</th>
            <th>Centro</th>
            <th>Item</th>
            <th>Qtd</th>
            <th>Status</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="tbodyPending"></tbody>
      </table>
      <div class="small" style="margin-top:10px">Aqui aparece apenas status <b>requested</b>. Ao autorizar, vai para a tela <b>Compras</b>.</div>
    </div>

    <div id="tab-track" class="hidden">
      <h2 style="margin-top:0;color:#ff6a00;">Acompanhamento</h2>
      <table>
        <thead>
          <tr>
            <th>Solicitante</th>
            <th>Centro</th>
            <th>Item</th>
            <th>Status</th>
            <th>Previsão</th>
            <th>Entrada</th>
          </tr>
        </thead>
        <tbody id="tbodyTrack"></tbody>
      </table>
      <div class="small" style="margin-top:10px">Mostra registros com status <b>authorized / purchased / received</b>. Atrasados ficam destacados.</div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
const firebaseConfig={
  apiKey:"AIzaSyBPz4aSee-kQY5hwlyzEw_4Jv3gGKL9iHY",
  authDomain:"tmg-painel.firebaseapp.com",
  databaseURL:"https://tmg-painel-default-rtdb.firebaseio.com",
  projectId:"tmg-painel",
  storageBucket:"tmg-painel.firebasestorage.app",
  messagingSenderId:"877912378151",
  appId:"1:877912378151:web:88af3a4f8f551acd603702"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ALTERE SE QUISER
const PIN_ADMIN_COMPRAS = "1234";

const pinCard = document.getElementById('pinCard');
const appCard = document.getElementById('appCard');
const pinInput = document.getElementById('pinInput');
const btnPin = document.getElementById('btnPin');
const pinCard = document.getElementById('pinCard');
const appCard = document.getElementById('appCard');

// evita duplicar listeners e evita erro de TDZ
var started = false;

function unlockUI(){
  if(pinCard) pinCard.style.display = 'none';
  if(appCard){
    appCard.classList.remove('hidden');
    appCard.style.display = 'block';
  }
}
function lockUI(){
  if(pinCard) pinCard.style.display = 'block';
  if(appCard) appCard.style.display = 'none';
}

function isUnlocked(){
  return sessionStorage.getItem('ADMIN_COMPRAS_UNLOCKED') === '1';
}
function setUnlocked(v){
  sessionStorage.setItem('ADMIN_COMPRAS_UNLOCKED', v ? '1' : '0');
}

if(btnPin){
  btnPin.addEventListener('click', () => {
    const val = (pinInput?.value || '').trim();
    if(val === PIN_ADMIN_COMPRAS){
      setUnlocked(true);
      unlockUI();
      startListeners();
    } else {
      alert('PIN incorreto');
    }
  });
}

// mantém destravado ao recarregar
if(isUnlocked()){
  unlockUI();
  startListeners();
} else {
  lockUI();
}
function startListeners(){
  if(started) return;
  started = true;
  db.ref('purchaseRequests').on('value', function(snap){
    const data = snap.val() || {};
    const arr = Object.keys(data).map(function(id){
      return Object.assign({ id: id }, data[id]);
    });
    renderPending(arr);
    renderTrack(arr);
  });
}

function renderPending(arr){
  const tbody = document.getElementById('tbodyPending');
  const pend = arr
    .filter(function(x){ return (x.status || '').toLowerCase() === 'requested'; })
    .sort(function(a,b){ return (b.createdAt||0) - (a.createdAt||0); });

  if(!pend.length){
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;opacity:.8">Nenhuma requisição pendente</td></tr>';
    return;
  }

  tbody.innerHTML = pend.map(function(x){
    const who = x.member || x.requestedBy || '-';
    const qty = (x.quantity || '-') + ' ' + (x.unit || '');
    return '<tr>' +
      '<td>' + fmtDateTime(x.createdAt) + '</td>' +
      '<td>' + who + '</td>' +
      '<td>' + (x.costCenter || '-') + '</td>' +
      '<td>' + (x.item || '-') + '</td>' +
      '<td>' + qty + '</td>' +
      '<td>' + pill(x.status) + '</td>' +
      '<td>' +
        '<button class="btn-green" onclick="authorizeReq(\'' + x.id + '\')">Autorizar</button> ' +
        '<button class="btn-red" onclick="rejectReq(\'' + x.id + '\')">Recusar</button>' +
      '</td>' +
    '</tr>';
  }).join('');
}

function renderTrack(arr){
  const tbody = document.getElementById('tbodyTrack');
  const show = arr
    .filter(function(x){
      const s = (x.status || '').toLowerCase();
      return s === 'authorized' || s === 'purchased' || s === 'received';
    })
    .sort(function(a,b){ return (b.updatedAt||b.createdAt||0) - (a.updatedAt||a.createdAt||0); });

  if(!show.length){
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;opacity:.8">Sem registros para acompanhar</td></tr>';
    return;
  }

  tbody.innerHTML = show.map(function(x){
    const who = x.member || x.requestedBy || '-';
    const overdue = isOverdue(x);
    const trClass = overdue ? ' class="overdue"' : '';
    return '<tr' + trClass + '>' +
      '<td>' + who + '</td>' +
      '<td>' + (x.costCenter || '-') + '</td>' +
      '<td>' + (x.item || '-') + '</td>' +
      '<td>' + pill(x.status) + '</td>' +
      '<td>' + fmtDateTime(x.deliveryExpectedAt) + '</td>' +
      '<td>' + fmtDateTime(x.receivedAt) + '</td>' +
    '</tr>';
  }).join('');
}

window.authorizeReq = function(id){
  const now = Date.now();
  db.ref('purchaseRequests/' + id).update({
    status: 'authorized',
    authorizedAt: now,
    updatedAt: now
  });
};
window.rejectReq = function(id){
  const now = Date.now();
  if(!confirm('Recusar esta requisição?')) return;
  db.ref('purchaseRequests/' + id).update({
    status: 'rejected',
    rejectedAt: now,
    updatedAt: now
  });
};

document.getElementById('btnZerar').addEventListener('click', function(){
  if(!confirm('Isso vai apagar TODO o histórico de compras/requisições. Confirmar?')) return;
  db.ref('purchaseRequests').remove();
});

document.querySelectorAll('.tabbtn[data-tab]').forEach(function(btn){
  btn.addEventListener('click', function(){
    document.querySelectorAll('.tabbtn[data-tab]').forEach(function(b){ b.classList.remove('active'); });
    btn.classList.add('active');
    const tab = btn.getAttribute('data-tab');
    document.getElementById('tab-auth').classList.toggle('hidden', tab !== 'auth');
    document.getElementById('tab-track').classList.toggle('hidden', tab !== 'track');
  });
});
</script>
</body>
</html>
