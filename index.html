<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Cronograma Oficina - TMG Racing</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
html,body{margin:0;width:100%;height:100%;font-family:'Orbitron',Arial,sans-serif;background:radial-gradient(circle at top,#0a0a0a,#000);color:#00e5ff;overflow:hidden;}
header{display:flex;align-items:center;justify-content:space-between;padding:14px 26px;background:linear-gradient(90deg,#bdbdbd,#e0e0e0,#bdbdbd);box-shadow:0 0 20px rgba(0,0,0,.45);}
.header-left{display:flex;align-items:center;gap:18px;font-size:2.1rem;font-weight:800;letter-spacing:2px;text-transform:uppercase;color:#000;}
.header-left img{height:120px;filter:drop-shadow(0 0 12px rgba(0,0,0,.6));}
.clock{background:rgba(0,0,0,.75);color:#fff;padding:10px 18px;border-radius:16px;font-size:1.4rem;letter-spacing:2px;}

.container{display:grid;grid-template-columns:3.2fr 0.8fr;gap:12px;padding:12px;height:calc(100vh - 150px);}
.panel{background:rgba(0,0,0,.78);border-radius:18px;padding:14px;border:2px solid rgba(0,229,255,.22);box-shadow:0 0 26px rgba(0,229,255,.25);overflow:auto;}
h2{text-align:center;color:#ff3d00;letter-spacing:2px;text-transform:uppercase;}

.group-card{background:rgba(255,255,255,.03);border:1px solid rgba(0,229,255,.18);border-radius:14px;padding:10px;margin-bottom:10px;}
.group-title{font-weight:800;color:#fff;margin-bottom:8px}

.task{display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;padding:8px 10px;margin-bottom:6px;border-radius:12px;border:1px solid rgba(0,229,255,.15);background:rgba(0,0,0,.35);}
.task-name{font-weight:700;}
.badge{padding:6px 10px;border-radius:999px;font-size:.75rem;font-weight:900;text-transform:uppercase;}
.todo{background:#ff1744;color:#fff}
.doing{background:#ffea00;color:#000}
.pending{background:#00e5ff;color:#000}
.done{background:#64dd17;color:#000}

.countdown{font-size:.72rem;opacity:.9;margin-top:4px}
.dates ul{list-style:none;padding:0;margin:0}
.dates li{background:rgba(0,0,0,.6);border-left:6px solid red;padding:10px;border-radius:12px;margin-bottom:10px}
</style>
</head>

<body>
<header>
  <div class="header-left">
    <img src="logo_tmg_clean.png">
    Cronograma Oficina
  </div>
  <div class="clock" id="clock">00:00</div>
</header>

<div class="container">
  <div class="panel">
    <h2>Tarefas</h2>
    <div id="tasks"></div>
  </div>

  <div class="panel dates">
    <h2>Datas</h2>
    <ul id="dates"></ul>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBPz4aSee-kQY5hwlyzEw_4Jv3gGKL9iHY",
  authDomain: "tmg-painel.firebaseapp.com",
  databaseURL: "https://tmg-painel-default-rtdb.firebaseio.com",
  projectId: "tmg-painel",
  storageBucket: "tmg-painel.firebasestorage.app",
  messagingSenderId: "877912378151",
  appId: "1:877912378151:web:88af3a4f8f551acd603702"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

setInterval(()=>{
  const d=new Date();
  document.getElementById("clock").innerText=d.toLocaleTimeString("pt-BR",{hour:'2-digit',minute:'2-digit',second:'2-digit'});
},1000);

function getTaskPeople(t){
  if(Array.isArray(t.people)&&t.people.length) return t.people;
  if(typeof t.person==="string"&&t.person.trim()) return [t.person.trim()];
  return ["Sem responsável"];
}

function countdown(dueAt){
  if(!dueAt) return "";
  const diff=dueAt-Date.now();
  const h=Math.floor(Math.abs(diff)/36e5);
  const d=Math.floor(h/24);
  if(diff<0) return `⛔ Atrasado ${d}d`;
  if(d===0) return `⚠️ ${h}h restantes`;
  return `⏳ ${d}d ${h%24}h`;
}

/* Tasks grouped by person */
db.ref("tasks").on("value",snap=>{
  const data=snap.val()||{};
  const groups={};

  Object.values(data).forEach(t=>{
    getTaskPeople(t).forEach(p=>{
      if(!groups[p]) groups[p]=[];
      groups[p].push(t);
    });
  });

  const wrap=document.getElementById("tasks");
  wrap.innerHTML="";

  Object.keys(groups).sort().forEach(person=>{
    const card=document.createElement("div");
    card.className="group-card";
    card.innerHTML=`<div class="group-title">${person}</div>`;

    groups[person].forEach(t=>{
      const div=document.createElement("div");
      div.className="task";
      div.innerHTML=`
        <div class="task-name">
          ${t.name||""}
          ${t.dueAt?`<div class="countdown">${countdown(t.dueAt)}</div>`:""}
        </div>
        <div class="badge ${t.status||"todo"}">${t.status||""}</div>
        <div class="badge">${t.priority||""}</div>
      `;
      card.appendChild(div);
    });

    wrap.appendChild(card);
  });
});

/* Dates */
function parseYMD(ymd){
  const m=/^(\d{4})-(\d{2})-(\d{2})$/.exec(ymd||"");
  if(!m) return null;
  return new Date(m[1],m[2]-1,m[3]);
}

db.ref("dates").on("value",snap=>{
  const ul=document.getElementById("dates");
  ul.innerHTML="";
  const arr=Object.values(snap.val()||{});
  arr.sort((a,b)=>(a.date||"").localeCompare(b.date||""));
  arr.forEach(d=>{
    const li=document.createElement("li");
    li.innerHTML=`<strong>${d.title||""}</strong><br>${d.date||""}`;
    ul.appendChild(li);
  });
});
</script>
</body>
</html>
