<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Requisição de Compras</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
  body{margin:0;font-family:'Orbitron',Arial,sans-serif;background:radial-gradient(circle at top,#0a0a0a,#000);color:#00e5ff;}
  header{padding:14px;background:linear-gradient(90deg,#bdbdbd,#e0e0e0,#bdbdbd);color:#000;font-weight:900;text-align:center;}
  .container{padding:14px;max-width:520px;margin:auto;}
  .card{background:rgba(0,0,0,.78);border-radius:18px;padding:16px;border:2px solid rgba(0,229,255,.22);box-shadow:0 0 26px rgba(0,229,255,.22);}
  h2{text-align:center;color:#ff3d00;margin-top:0;}
  label{display:block;margin-top:12px;font-size:.85rem;}
  input,select,textarea{
    width:100%;padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.2);
    background:rgba(255,255,255,.08);color:#fff;font-family:'Orbitron',Arial,sans-serif;margin-top:4px;
  }
  textarea{resize:vertical;}
  button{
    margin-top:16px;width:100%;padding:14px;border-radius:16px;border:none;
    background:linear-gradient(90deg,#00c853,#64dd17);color:#000;font-weight:900;font-size:1rem;cursor:pointer;
  }
  .status{margin-top:14px;font-size:.85rem;text-align:center;opacity:.9;}
  .badge{
    display:inline-block;margin-top:10px;padding:10px 12px;border-radius:14px;
    background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.16);
    color:#fff;font-size:.78rem;line-height:1.35;
  }
</style>
</head>

<body>
<header>Requisição de Compras / Serviços</header>

<div class="container">
  <div class="card">
    <h2>Nova Requisição</h2>

    <label>Seu nome</label>
    <input id="member" placeholder="Ex: Davi">

    <div class="badge" id="prefillInfo" style="display:none;"></div>

    <label>Centro de custo</label>
    <select id="cost">
      <option>Oficina Geral</option>
      <option>Projeto X</option>
      <option>Projeto Y</option>
      <option>Desenvolvimento</option>
      <option>Pista / Testes</option>
      <option>Administrativo</option>
    </select>

    <label>Material ou serviço</label>
    <input id="item" placeholder="Ex: Usinagem suporte alumínio">

    <label>Quantidade</label>
    <input id="qty" type="number" min="0" step="any">

    <label>Unidade</label>
    <select id="unit">
      <option>un</option>
      <option>kg</option>
      <option>m</option>
      <option>m²</option>
      <option>l</option>
      <option>jogo</option>
      <option>serviço</option>
    </select>

    <label>Observação</label>
    <textarea id="obs" rows="3"></textarea>

    <button id="btnSend" onclick="send()">Enviar requisição</button>
    <div class="status" id="status"></div>
  </div>
</div>

<script>
const firebaseConfig={
  apiKey:"AIzaSyBPz4aSee-kQY5hwlyzEw_4Jv3gGKL9iHY",
  authDomain:"tmg-painel.firebaseapp.com",
  databaseURL:"https://tmg-painel-default-rtdb.firebaseio.com",
  projectId:"tmg-painel",
  storageBucket:"tmg-painel.firebasestorage.app",
  messagingSenderId:"877912378151",
  appId:"1:877912378151:web:88af3a4f8f551acd603702"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

function qs(){
  const p = new URLSearchParams(window.location.search);
  // aceita ?u= ou ?member=
  return { u: (p.get("u")||"").trim(), member: (p.get("member")||"").trim() };
}

function setStatus(msg){ document.getElementById("status").innerText = msg; }
function norm(s){ return (s||"").trim(); }

function prefillMember(){
  const el = document.getElementById("member");
  const info = document.getElementById("prefillInfo");

  const { u, member } = qs();
  const fromQuery = norm(u || member);
  const fromSession = norm(localStorage.getItem("tmg_member_name") || "");

  const chosen = fromQuery || fromSession;
  if(chosen){
    el.value = chosen;
    // deixa editável (caso precise), mas mostra que veio preenchido
    info.style.display = "block";
    info.textContent = fromQuery
      ? "Nome preenchido automaticamente (atalho/QR)."
      : "Nome preenchido automaticamente (sessão da Equipe).";
  } else {
    info.style.display = "none";
  }
}

function send(){
  const member = norm(document.getElementById("member").value);
  const item = norm(document.getElementById("item").value);
  const qtyRaw = document.getElementById("qty").value;

  if(!member || !item || !qtyRaw){
    setStatus("Preencha: nome, material/serviço e quantidade.");
    return;
  }

  const qty = Number(qtyRaw);
  if(!isFinite(qty) || qty <= 0){
    setStatus("Quantidade inválida.");
    return;
  }

  // salva para atalhos futuros
  localStorage.setItem("tmg_member_name", member);

  const data = {
    member,
    cost: document.getElementById("cost").value,
    item,
    qty,
    unit: document.getElementById("unit").value,
    obs: norm(document.getElementById("obs").value),
    requestedAt: Date.now(),
    status: "requested"
  };

  const btn = document.getElementById("btnSend");
  btn.disabled = true;
  btn.style.opacity = .85;
  setStatus("Enviando...");

  db.ref("purchaseRequests").push(data).then(()=>{
    setStatus("Requisição enviada com sucesso ✔️");
    document.getElementById("item").value = "";
    document.getElementById("qty").value = "";
    document.getElementById("unit").value = "un";
    document.getElementById("obs").value = "";
  }).catch((e)=>{
    console.log(e);
    setStatus("Falha ao enviar. Verifique sua internet.");
  }).finally(()=>{
    btn.disabled = false;
    btn.style.opacity = 1;
  });
}

prefillMember();
</script>
</body>
</html>
